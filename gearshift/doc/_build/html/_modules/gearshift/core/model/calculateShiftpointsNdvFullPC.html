

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gearshift.core.model.calculateShiftpointsNdvFullPC &mdash; GEARSHIFT 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> GEARSHIFT
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">GEARSHIFT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../gearshift.html">gearshift</a> &raquo;</li>
        
          <li><a href="../../core.html">gearshift.core</a> &raquo;</li>
        
      <li>gearshift.core.model.calculateShiftpointsNdvFullPC</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gearshift.core.model.calculateShiftpointsNdvFullPC</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2015-2020 European Commission (JRC);</span>
<span class="c1"># Licensed under the EUPL (the &#39;Licence&#39;);</span>
<span class="c1"># You may not use this work except in compliance with the Licence.</span>
<span class="c1"># You may obtain a copy of the Licence at: http://ec.europa.eu/idabc/eupl</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">It provides GEARSHIFT model `dsp` to obtain the gearshifts following Sub-Annex 2 of the Annex XXI from the</span>
<span class="sd">COMMISSION REGULATION (EU) 2017/1151.</span>

<span class="sd">Docstrings should provide sufficient understanding for any individual function.</span>

<span class="sd">Sub-Modules:</span>

<span class="sd">.. currentmodule:: gearshift.core.model.physical</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :nosignatures:</span>
<span class="sd">    :toctree: calculateShiftpointsNdvFullPC/</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">schedula</span> <span class="k">as</span> <span class="nn">sh</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">.corrections</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">dsp</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">BlueDispatcher</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;GEARSHIFT calculateShiftpointsNdvFullPC model&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;This function calibrates the speed trance, following the Sub-Annex 2&quot;</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="check_gears"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.check_gears">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;NoOfGearsFinal&quot;</span><span class="p">,</span> <span class="s2">&quot;Gears&quot;</span><span class="p">,</span> <span class="s2">&quot;NdvRatios&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check_gears</span><span class="p">(</span><span class="n">NoOfGears</span><span class="p">,</span> <span class="n">gear_nbrs</span><span class="p">,</span> <span class="n">Ndv</span><span class="p">,</span> <span class="n">ExcludeCrawlerGear</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if is necessary exclude the first gear from the input gears</span>

<span class="sd">    :param NoOfGears:</span>
<span class="sd">        Annex 2 (2d) ng. The number of forward gears.</span>
<span class="sd">    :type NoOfGears: Integer</span>

<span class="sd">    :param gear_nbrs:</span>
<span class="sd">        List with of gears of the vehicle.</span>
<span class="sd">    :type gear_nbrs: list</span>

<span class="sd">    :param Ndv:</span>
<span class="sd">        Annex 2 (2e) i ==&gt; (n/v)_i</span>
<span class="sd">        The ratio obtained by dividing the engine speed n by the vehicle speed v</span>
<span class="sd">        for each gear i form 1 to ng.</span>
<span class="sd">    :type Ndv: list</span>

<span class="sd">    :param ExcludeCrawlerGear:</span>
<span class="sd">        Annex 2 (2j)</span>
<span class="sd">        Gear 1 may be excluded at the request of . the manufacturer if</span>
<span class="sd">    :type ExcludeCrawlerGear: boolean</span>

<span class="sd">    :returns:</span>
<span class="sd">        - NoOfGearsFinal (:py:class:`int`):</span>
<span class="sd">            The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">            if is necessary.</span>

<span class="sd">        - Gears (:py:class:`list`):</span>
<span class="sd">            List with of gears of the vehicle after apply the exclusion of first</span>
<span class="sd">            gear if is necessary.</span>

<span class="sd">        - NdvRatios (:py:class:`numpy.array`):</span>
<span class="sd">            The ratio obtained by dividing the engine speed n by the vehicle speed</span>
<span class="sd">            v for each gear i form 1 to ng after apply the exclusion of first gear</span>
<span class="sd">            if is necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ExcludeCrawlerGear</span><span class="p">:</span>
        <span class="n">Gears</span> <span class="o">=</span> <span class="n">gear_nbrs</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="n">NdvRatios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ndv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">NoOfGearsFinal</span> <span class="o">=</span> <span class="n">NoOfGears</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Gears</span> <span class="o">=</span> <span class="n">gear_nbrs</span>
        <span class="n">NdvRatios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ndv</span><span class="p">)</span>
        <span class="n">NoOfGearsFinal</span> <span class="o">=</span> <span class="n">NoOfGears</span>

    <span class="k">return</span> <span class="n">NoOfGearsFinal</span><span class="p">,</span> <span class="n">Gears</span><span class="p">,</span> <span class="n">NdvRatios</span></div>


<div class="viewcode-block" id="parse_speed_trace"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.parse_speed_trace">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TraceTimesInput&quot;</span><span class="p">,</span> <span class="s2">&quot;RequiredVehicleSpeedsInput&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">parse_speed_trace</span><span class="p">(</span><span class="n">speed_trace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split speed trace in trace times and required vehicles speeds</span>

<span class="sd">    :param speed_trace:</span>
<span class="sd">        Annex 1 (eg 8.3) i ==&gt; v_i</span>
<span class="sd">        The vehicle speed at second i.</span>
<span class="sd">    :type speed_trace: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - TraceTimesInput (:py:class:`numpy.array`):</span>
<span class="sd">            Times for each vehicle speed required</span>
<span class="sd">        - RequiredVehicleSpeedsInput (:py:class:`numpy.array`):</span>
<span class="sd">            The vehicle speed required for the whole cycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TraceTimesInput</span> <span class="o">=</span> <span class="n">speed_trace</span><span class="p">[</span><span class="s2">&quot;ApplicableTrace&quot;</span><span class="p">][</span><span class="s2">&quot;compensatedTraceTimes&quot;</span><span class="p">]</span>
    <span class="n">RequiredVehicleSpeedsInput</span> <span class="o">=</span> <span class="n">speed_trace</span><span class="p">[</span><span class="s2">&quot;ApplicableTrace&quot;</span><span class="p">][</span>
        <span class="s2">&quot;compensatedVehicleSpeeds&quot;</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">TraceTimesInput</span><span class="p">,</span> <span class="n">RequiredVehicleSpeedsInput</span></div>


<div class="viewcode-block" id="resample_trace"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.resample_trace">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span>
    <span class="n">dsp</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TraceTimes&quot;</span><span class="p">,</span> <span class="s2">&quot;RequiredVehicleSpeeds&quot;</span><span class="p">,</span> <span class="s2">&quot;TraceTimesCount&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">resample_trace</span><span class="p">(</span><span class="n">TraceTimesInput</span><span class="p">,</span> <span class="n">RequiredVehicleSpeedsInput</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Re-sample the trace in 1Hz</span>

<span class="sd">    :param TraceTimesInput:</span>
<span class="sd">        Times for each vehicle speed required</span>
<span class="sd">    :type TraceTimesInput: array</span>

<span class="sd">    :param RequiredVehicleSpeedsInput:</span>
<span class="sd">        The vehicle speed required for the whole cycle.</span>
<span class="sd">    :type RequiredVehicleSpeedsInput: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - TraceTimes (:py:class:`numpy.array`):</span>
<span class="sd">            Times for each vehicle speed required re-sampled in 1Hz</span>
<span class="sd">        - RequiredVehicleSpeeds (:py:class:`numpy.array`):</span>
<span class="sd">            The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">        - TraceTimesCount (:py:class:`int`):</span>
<span class="sd">            The length of trace times re-sampled in 1Hz</span>

<span class="sd">    .. note:: If the trace was provided with higher sample rate, this may lead to data loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

    <span class="n">TraceTimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">TraceTimesInput</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">RequiredVehicleSpeeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span>
        <span class="n">interp1d</span><span class="p">(</span><span class="n">TraceTimesInput</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">RequiredVehicleSpeedsInput</span><span class="p">)(</span><span class="n">TraceTimes</span><span class="p">),</span> <span class="mi">4</span>
    <span class="p">)</span>
    <span class="n">TraceTimesCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">TraceTimes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TraceTimes</span><span class="p">,</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span> <span class="n">TraceTimesCount</span></div>


<div class="viewcode-block" id="identify_phases"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.identify_phases">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span>
    <span class="n">dsp</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;Phases&quot;</span><span class="p">,</span>
        <span class="s2">&quot;InDecelerationToStandstill&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PhaseValues&quot;</span><span class="p">,</span>
        <span class="s2">&quot;InStandStill&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PhaseStarts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PhaseEnds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PHASE_ACCELERATION_FROM_STANDSTILL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PHASE_ACCELERATION&quot;</span><span class="p">,</span>
        <span class="s2">&quot;InAcceleration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;InConstantSpeed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;InAccelerationAnyDuration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PHASE_DECELERATION&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PHASE_DECELERATION_TO_STANDSTILL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;InDeceleration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PHASE_STANDSTILL&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">identify_phases</span><span class="p">(</span><span class="n">TraceTimesCount</span><span class="p">,</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify phases</span>

<span class="sd">    :param TraceTimesCount:</span>
<span class="sd">        The length of trace times re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimesCount: integer</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - Phases (:py:class:`numpy.array`):</span>
<span class="sd">            The list of phases that are used during whole cycle</span>
<span class="sd">        - InDecelerationToStandstill (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The array that contains the seconds from deceleration to standstill as a True</span>
<span class="sd">        - PhaseValues (:py:class:`numpy.array`):</span>
<span class="sd">            Contains the points of changes phases</span>
<span class="sd">        - InStandStill (:py:class:`boolean numpy.array`):</span>
<span class="sd">            Contains the points that are in standstill phase as a True</span>
<span class="sd">        -  PhaseStarts (:py:class:`numpy.array`):</span>
<span class="sd">            Contains the points that are start point from a phase</span>
<span class="sd">        - PhaseEnds (:py:class:`numpy.array`):</span>
<span class="sd">            Contains the points that are end point from a phase</span>
<span class="sd">        - PHASE_ACCELERATION_FROM_STANDSTILL (:py:class:`int`):</span>
<span class="sd">            Acceleration phase following a standstill phase</span>
<span class="sd">        - PHASE_ACCELERATION (:py:class:`int`):</span>
<span class="sd">            Acceleration phase</span>
<span class="sd">        - InAcceleration (:py:class:`boolean numpy.array`):</span>
<span class="sd">            Contains the points that are in acceleration phase as a True</span>
<span class="sd">        - InConstantSpeed (:py:class:`boolean numpy.array`):</span>
<span class="sd">            Contains the points that are in constant speed phase as a True</span>
<span class="sd">        - InAccelerationAnyDuration (:py:class:`boolean numpy.array`):</span>
<span class="sd">            Some gear corrections ignore the duration of acceleration phases so save acceleration phases</span>
<span class="sd">            with any duration here.</span>
<span class="sd">        - PHASE_DECELERATION (:py:class:`int`):</span>
<span class="sd">            Time period of more than 2 seconds with required vehicle:</span>
<span class="sd">                speed &gt;= 1km/h and monotonically decreasing</span>
<span class="sd">        - PHASE_DECELERATION_TO_STANDSTILL (:py:class:`int`):</span>
<span class="sd">            DECELERATION phase preceding a STANDSTILL phase</span>
<span class="sd">        -  InDeceleration (:py:class:`boolean numpy.array`):</span>
<span class="sd">            Contains the points that are in deceleration phase as a True</span>
<span class="sd">        - PHASE_STANDSTILL (:py:class:`int`):</span>
<span class="sd">            Time period with required vehicle speed &lt; 1km/h</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PHASE_TOO_SHORT</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PHASE_STANDSTILL</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">PHASE_ACCELERATION</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">PHASE_DECELERATION</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">PHASE_CONSTANT_SPEED</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="n">Phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">TraceTimesCount</span><span class="p">)</span>

    <span class="n">dif_RequiredVehicleSpeeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">)</span>
    <span class="n">dif_RequiredVehicleSpeeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dif_RequiredVehicleSpeeds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">Phases</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">PHASE_STANDSTILL</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">Phases</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dif_RequiredVehicleSpeeds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">PHASE_ACCELERATION</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">Phases</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dif_RequiredVehicleSpeeds</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">PHASE_DECELERATION</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">Phases</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dif_RequiredVehicleSpeeds</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">PHASE_CONSTANT_SPEED</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">InAccelerationAnyDuration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">TraceTimesCount</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">InAccelerationAnyDuration</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION</span><span class="p">),</span>
        <span class="n">PHASE_STANDSTILL</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">PhaseEnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Phases</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">PhaseLengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">PhaseEnds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">PhaseValues</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">PhaseEnds</span><span class="p">]</span>
    <span class="n">PreviousPhaseValues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">PhaseValues</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">NextPhaseValues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PhaseValues</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">PhaseValues</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PreviousPhaseValues</span> <span class="o">==</span> <span class="n">PHASE_STANDSTILL</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">PhaseValues</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">NextPhaseValues</span> <span class="o">==</span> <span class="n">PHASE_STANDSTILL</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">PhaseValues</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseLengths</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">!=</span> <span class="n">PHASE_CONSTANT_SPEED</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">!=</span> <span class="n">PHASE_STANDSTILL</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">PHASE_TOO_SHORT</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">PhaseStarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">PhaseLengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">PhaseStarts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PhaseChanges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">TraceTimesCount</span><span class="p">)</span>
    <span class="n">PhaseChanges</span><span class="p">[</span><span class="n">PhaseStarts</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">Phases</span> <span class="o">=</span> <span class="n">PhaseValues</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">PhaseChanges</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">InStandStill</span><span class="p">,</span> <span class="n">InAcceleration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InStandStill</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_STANDSTILL</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InAcceleration</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InAcceleration</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">InAccelerationFromStandstill</span><span class="p">,</span> <span class="n">InDeceleration</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">)),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">InAccelerationFromStandstill</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InDeceleration</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InDeceleration</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">InDecelerationToStandstill</span><span class="p">,</span> <span class="n">InConstantSpeed</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">)),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">InDecelerationToStandstill</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InConstantSpeed</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_CONSTANT_SPEED</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">Phases</span><span class="p">,</span>
        <span class="n">InDecelerationToStandstill</span><span class="p">,</span>
        <span class="n">PhaseValues</span><span class="p">,</span>
        <span class="n">InStandStill</span><span class="p">,</span>
        <span class="n">PhaseStarts</span><span class="p">,</span>
        <span class="n">PhaseEnds</span><span class="p">,</span>
        <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">,</span>
        <span class="n">PHASE_ACCELERATION</span><span class="p">,</span>
        <span class="n">InAcceleration</span><span class="p">,</span>
        <span class="n">InConstantSpeed</span><span class="p">,</span>
        <span class="n">InAccelerationAnyDuration</span><span class="p">,</span>
        <span class="n">PHASE_DECELERATION</span><span class="p">,</span>
        <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">,</span>
        <span class="n">InDeceleration</span><span class="p">,</span>
        <span class="n">PHASE_STANDSTILL</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_ExponentialDecayingASM</span><span class="p">(</span>
    <span class="n">EngineSpeed</span><span class="p">,</span> <span class="n">AdditionalSafetyMargin0</span><span class="p">,</span> <span class="n">StartEngineSpeed</span><span class="p">,</span> <span class="n">EndEngineSpeed</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">AdditionalSafetyMargin0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ASM</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">EndEngineSpeed</span> <span class="o">&lt;=</span> <span class="n">StartEngineSpeed</span><span class="p">:</span>
        <span class="n">ASM</span> <span class="o">=</span> <span class="n">AdditionalSafetyMargin0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ASM</span> <span class="o">=</span> <span class="n">AdditionalSafetyMargin0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">AdditionalSafetyMargin0</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">EngineSpeed</span> <span class="o">-</span> <span class="n">StartEngineSpeed</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">EngineSpeed</span> <span class="o">-</span> <span class="n">StartEngineSpeed</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">ASM</span>


<div class="viewcode-block" id="load_full_power_curve"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.load_full_power_curve">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span>
    <span class="n">dsp</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;PowerCurveEngineSpeeds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PowerCurvePowers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PowerCurveASM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DefinedPowerCurveAdditionalSafetyMargins&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">load_full_power_curve</span><span class="p">(</span>
    <span class="n">FullPowerCurve</span><span class="p">,</span> <span class="n">AdditionalSafetyMargin0</span><span class="p">,</span> <span class="n">StartEngineSpeed</span><span class="p">,</span> <span class="n">EndEngineSpeed</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load full power curve</span>

<span class="sd">    :param FullPowerCurve:</span>
<span class="sd">        Annex 2 (2h) and (3.4) n ==&gt; P_wot(n), ASM</span>
<span class="sd">        The full load power curve over the engine speed range.</span>
<span class="sd">    :type FullPowerCurve: array</span>

<span class="sd">    :param AdditionalSafetyMargin0:</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-72-10-Rev.2.</span>
<span class="sd">        Later regulations define the additional safety margin values</span>
<span class="sd">        as part of the FullPowerCurve.</span>
<span class="sd">    :type AdditionalSafetyMargin0: array</span>

<span class="sd">    :param StartEngineSpeed:</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-72-10-Rev.2.</span>
<span class="sd">        GRPE-72-10-Rev.2 Annex 2 (3.4) n_start</span>
<span class="sd">        The engine speed at which ASM approching zero starts.</span>
<span class="sd">    :type StartEngineSpeed: array</span>

<span class="sd">    :param EndEngineSpeed:</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-72-10-Rev.2.</span>
<span class="sd">        GRPE-72-10-Rev.2 Annex 2 (3.4) n_end</span>
<span class="sd">        The engine speed at which ASM approching zero ends.</span>
<span class="sd">    :type EndEngineSpeed: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - PowerCurveEngineSpeeds (:py:class:`numpy.array`):</span>
<span class="sd">            Contains the power curve engine speeds</span>
<span class="sd">        - PowerCurvePowers (:py:class:`numpy.array`):</span>
<span class="sd">            Contains the power curve powers</span>
<span class="sd">        - PowerCurveASM (:py:class:`numpy.array`):</span>
<span class="sd">            Contains the power curve additional save margin</span>
<span class="sd">        - DefinedPowerCurveAdditionalSafetyMargins (:py:class:`bool`):</span>
<span class="sd">            Boolean that define if the additional save margins are present</span>

<span class="sd">    .. note:: This function split the different components of full power curve in a independent array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">FullPowerCurve</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ASM</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">FullPowerCurve</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ASM</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="n">_ExponentialDecayingASM</span><span class="p">(</span>
                        <span class="n">FullPowerCurve</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">AdditionalSafetyMargin0</span><span class="p">,</span>
                        <span class="n">StartEngineSpeed</span><span class="p">,</span>
                        <span class="n">EndEngineSpeed</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="mi">10</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="mi">10</span>
            <span class="p">)</span>

        <span class="n">FullPowerCurve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FullPowerCurve</span><span class="p">,</span> <span class="n">ASM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">PowerCurveEngineSpeeds</span> <span class="o">=</span> <span class="n">FullPowerCurve</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">PowerCurvePowers</span> <span class="o">=</span> <span class="n">FullPowerCurve</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">PowerCurveASM</span> <span class="o">=</span> <span class="n">FullPowerCurve</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">DefinedPowerCurveAdditionalSafetyMargins</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
        <span class="n">PowerCurvePowers</span><span class="p">,</span>
        <span class="n">PowerCurveASM</span><span class="p">,</span>
        <span class="n">DefinedPowerCurveAdditionalSafetyMargins</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="determine_rated_engine_power"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.determine_rated_engine_power">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RatedEnginePowerF&quot;</span><span class="p">,</span> <span class="s2">&quot;RatedEngineSpeedF&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">determine_rated_engine_power</span><span class="p">(</span>
    <span class="n">RatedEnginePower</span><span class="p">,</span> <span class="n">RatedEngineSpeed</span><span class="p">,</span> <span class="n">PowerCurvePowers</span><span class="p">,</span> <span class="n">PowerCurveEngineSpeeds</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine rated engine power and rated engine speed from the full power curve</span>

<span class="sd">    .. note::</span>
<span class="sd">    The following requirement was deleted from the regulation but as there is no</span>
<span class="sd">    new requirement we will stay with the old one :</span>
<span class="sd">    If the maximum power is developed over an engine speed range, n_rated shall be</span>
<span class="sd">    the minimum of this range</span>

<span class="sd">    :param RatedEnginePower:</span>
<span class="sd">        Annex 2 (2a) P_rated.</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-75-23.The maximum rated</span>
<span class="sd">        engine power as declared by the manufacturer. But the newer regulation</span>
<span class="sd">        GRPE/2018/2 Annex 2 (2g) now requires : The data sets and the values P_rated</span>
<span class="sd">        and n_rated shall be taken from the power curve as declared by the manufacturer.</span>

<span class="sd">        For backward compatibility this parameter may still be used to override the</span>
<span class="sd">        value calculated from FullPowerCurve. Set RatedEnginePower and RatedEngineSpeed</span>
<span class="sd">        to 0 to use the calculated values.</span>
<span class="sd">    :type RatedEnginePower: numpy.array</span>

<span class="sd">    :param RatedEngineSpeed:</span>
<span class="sd">        Annex 2 (2b) n_rated. This is a legacy parameter used until regulation GRPE-75-23.</span>
<span class="sd">        The rated engine speed at which an engine declared by the manufacturer as the</span>
<span class="sd">        engine speed at which the engine develops its maximum power.</span>

<span class="sd">        But the newer regulation GRPE/2018/2 Annex 2 (2g) now requires: The data sets and</span>
<span class="sd">        the values P_rated and n_rated shall be taken from the power curve as declared by</span>
<span class="sd">        the manufacturer.</span>

<span class="sd">        For backward compatibility this parameter may still be used to override the value</span>
<span class="sd">        calculated from FullPowerCurve. Set RatedEnginePower and RatedEngineSpeed to 0</span>
<span class="sd">        to use the calculated values.</span>
<span class="sd">    :type RatedEngineSpeed: numpy.array</span>

<span class="sd">    :param PowerCurvePowers:</span>
<span class="sd">        Contains the power curve powers</span>
<span class="sd">    :type PowerCurvePowers: numpy.array</span>

<span class="sd">    :param PowerCurveEngineSpeeds:</span>
<span class="sd">        Contains the power curve engine speeds</span>
<span class="sd">    :type PowerCurveEngineSpeeds: numpy.array</span>


<span class="sd">    :returns:</span>
<span class="sd">        - RatedEnginePowerF (:py:class:`float`):</span>
<span class="sd">            Contains the rated engine power corrected if is necessary</span>
<span class="sd">        - RatedEngineSpeedF (:py:class:`float`):</span>
<span class="sd">            Contains the rated engine speed corrected if is necessary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RatedEnginePower</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">RatedEnginePower</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="n">RatedEngineSpeed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">RatedEngineSpeed</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="n">RatedEnginePower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PowerCurvePowers</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PowerCurvePowers</span> <span class="o">==</span> <span class="n">RatedEnginePower</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">RatedEngineSpeed</span> <span class="o">=</span> <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">RatedEnginePower</span><span class="p">,</span> <span class="n">RatedEngineSpeed</span></div>


<div class="viewcode-block" id="determine_maximum_engine_speed_95"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.determine_maximum_engine_speed_95">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Max95EngineSpeedFinal&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">determine_maximum_engine_speed_95</span><span class="p">(</span>
    <span class="n">Max95EngineSpeed</span><span class="p">,</span> <span class="n">PowerCurvePowers</span><span class="p">,</span> <span class="n">PowerCurveEngineSpeeds</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the maximum engine speed where 95 percent of the rated power is</span>
<span class="sd">    reached from the full power curve</span>

<span class="sd">    :param Max95EngineSpeed:</span>
<span class="sd">        Annex 2 (2g) n_max1 = n_95_high</span>
<span class="sd">        The maximum engine speed where 95 per cent of rated power is reached.</span>
<span class="sd">        If the dummy value 0 will be given for this parameter then n_max1 will</span>
<span class="sd">        be calculated from parameter FullPowerCurve P_wot.</span>
<span class="sd">    :type Max95EngineSpeed: float</span>

<span class="sd">    :param PowerCurvePowers:</span>
<span class="sd">        Contains the power curve powers</span>
<span class="sd">    :type PowerCurvePowers: array</span>

<span class="sd">    :param PowerCurveEngineSpeeds:</span>
<span class="sd">        Contains the power curve engine speeds</span>
<span class="sd">    :type PowerCurveEngineSpeeds: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - Max95EngineSpeedFinal (:py:class:`float`):</span>
<span class="sd">            Annex 2 (2g) n_max1 = n_95_high adjusted.</span>
<span class="sd">            If n_95_high cannot be determined because the engine speed is limited to</span>
<span class="sd">            a lower value n_lim for all gears and the corresponding full load power</span>
<span class="sd">            is higher than 95 per cent of rated power, n_95_high shall be set to n_lim.</span>

<span class="sd">    .. note:: This will only be done if this value was not set as input parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Max95EngineSpeed</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Max95EngineSpeed</span><span class="p">):</span>
        <span class="n">PowerCurvePowerMax95</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PowerCurvePowers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PowerCurvePowers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">PowerCurvePowerMax95</span><span class="p">:</span>
            <span class="n">Max95EngineSpeed</span> <span class="o">=</span> <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logical</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">PowerCurvePowerMax95</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">PowerCurvePowers</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logical</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Max95EngineSpeed can not be calculated from FullPowerCurve&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Max95EngineSpeed</span> <span class="o">=</span> <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="n">PowerCurvePowerMax95</span> <span class="o">-</span> <span class="n">PowerCurvePowers</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">PowerCurvePowers</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PowerCurvePowers</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">)</span>
    <span class="n">Max95EngineSpeedFinal</span> <span class="o">=</span> <span class="n">Max95EngineSpeed</span>

    <span class="k">return</span> <span class="n">Max95EngineSpeedFinal</span></div>


<div class="viewcode-block" id="minimum_engine_speed_in_motion"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.minimum_engine_speed_in_motion">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span>
    <span class="n">dsp</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;MinDrivesI&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CalculatedMinDriveEngineSpeedGreater2nd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MinDrive1stTo2nd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MinDrive1st&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MinDrive2ndDecel&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MinDrive2nd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MinDriveGreater2nd&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">minimum_engine_speed_in_motion</span><span class="p">(</span>
    <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
    <span class="n">RatedEngineSpeedF</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeed1st</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeed1stTo2nd</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeed2ndDecel</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeed2nd</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2nd</span><span class="p">,</span>
    <span class="n">TraceTimesCount</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">InDecelerationToStandstill</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define minimum engine speeds when vehicle is in motion (2k)</span>

<span class="sd">    :param IdlingEngineSpeed:</span>
<span class="sd">        Annex 2 (2c) n_idle. The idling speed.</span>
<span class="sd">    :type IdlingEngineSpeed: float</span>

<span class="sd">    :param RatedEngineSpeedF:</span>
<span class="sd">        Contains the rated engine speed corrected if is necessary</span>
<span class="sd">    :type RatedEngineSpeedF: float</span>

<span class="sd">    :param MinDriveEngineSpeed1st:</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-75-23.</span>
<span class="sd">        This value may be used to increase the calculated value.</span>
<span class="sd">        Annex 2 (2k) n_min_drive = n_idle for n_gear:1</span>
<span class="sd">        The minimum engine speed when the vehicle is in motion.</span>
<span class="sd">    :type MinDriveEngineSpeed1st: float</span>

<span class="sd">    :param MinDriveEngineSpeed1stTo2nd:</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-75-23.</span>
<span class="sd">        This value may be used to increase the calculated value.</span>
<span class="sd">        Annex 2 (2ka) n_min_drive = 1.15 x n_idle for n_gear:1-&gt;2</span>
<span class="sd">        The minimum engine speed for transitions from first to second gear.</span>
<span class="sd">    :type MinDriveEngineSpeed1stTo2nd: float</span>

<span class="sd">    :param MinDriveEngineSpeed2ndDecel:</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-75-23.</span>
<span class="sd">        This value may be used to increase the calculated value.</span>
<span class="sd">        Annex 2 (2kb) n_min_drive = n_idle for n_gear:2</span>
<span class="sd">        The minimum engine speed for decelerations to standstill in second gear.</span>
<span class="sd">    :type MinDriveEngineSpeed2ndDecel: float</span>

<span class="sd">    :param MinDriveEngineSpeed2nd:</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-75-23.</span>
<span class="sd">        This value may be used to increase the calculated value.</span>
<span class="sd">        Annex 2 (2kc) n_min_drive = 0.9 x n_idle for n_gear:2</span>
<span class="sd">    :type MinDriveEngineSpeed2nd: float</span>

<span class="sd">    :param MinDriveEngineSpeedGreater2nd:</span>
<span class="sd">        This is a legacy parameter used until regulation GRPE-75-23.</span>
<span class="sd">        This value may be used to increase the calculated value.</span>
<span class="sd">        Annex 2 (2k) n_min_drive = n_idle + 0.125 × ( n_rated - n_idle ) for n_gear:3..</span>
<span class="sd">        This value shall be referred to as n_min_drive_set.</span>
<span class="sd">        The minimum engine speed for all driving conditions in gears greater than 2.</span>
<span class="sd">    :type MinDriveEngineSpeedGreater2nd: float</span>

<span class="sd">    :param TraceTimesCount:</span>
<span class="sd">        The length of trace times re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimesCount: integer</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :param InDecelerationToStandstill:</span>
<span class="sd">        The array that contains the seconds from deceleration to standstill as a True</span>
<span class="sd">    :type InDecelerationToStandstill: boolean array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - MinDrivesI (:py:class:`numpy.array`):</span>
<span class="sd">            Minimum engine speeds when vehicle is in motion</span>
<span class="sd">        - CalculatedMinDriveEngineSpeedGreater2nd (:py:class:`float`):</span>
<span class="sd">            The minimum drive engine speed grater than second</span>
<span class="sd">        - MinDrive1stTo2nd (:py:class:`float`):</span>
<span class="sd">            Annex 2 (2ka) n_min_drive = 1.15 x n_idle for n_gear:1-&gt;2</span>
<span class="sd">            The minimum engine speed for transitions from first to second gear.</span>
<span class="sd">            This is the maximum of calculated value and input parameter value.</span>
<span class="sd">        - MinDrive1st (:py:class:`float`):</span>
<span class="sd">            Annex 2 (2k) n_min_drive = n_idle for n_gear:1</span>
<span class="sd">            The minimum engine speed when the vehicle is in motion.</span>
<span class="sd">            This is the maximum of calculated value and input parameter value.</span>
<span class="sd">        - MinDrive2ndDecel (:py:class:`float`):</span>
<span class="sd">            Annex 2 (2kb) n_min_drive = n_idle for n_gear:2</span>
<span class="sd">            The minimum engine speed for decelerations to standstill in second gear.</span>
<span class="sd">            This is the maximum of calculated value and input parameter value.</span>
<span class="sd">        - MinDrive2nd (:py:class:`float`):</span>
<span class="sd">            Annex 2 (2kc) n_min_drive = 0.9 x n_idle for n_gear:2</span>
<span class="sd">            The minimum engine speed for all other driving conditions in second gear.</span>
<span class="sd">            This is the maximum of calculated value and input parameter value.</span>
<span class="sd">        - MinDriveGreater2nd (:py:class:`float`):</span>
<span class="sd">            Annex 2 (2k) n_min_drive = n_idle + 0.125 × ( n_rated - n_idle ) for n_gear:3..</span>
<span class="sd">            This value shall be referred to as n_min_drive_set.</span>
<span class="sd">            The minimum engine speed for all driving conditions in gears greater than 2.</span>
<span class="sd">            This is the maximum of calculated value and input parameter value.</span>

<span class="sd">    .. note:: The calculation of minimum engine speeds for the second gear does</span>
<span class="sd">        not fully confirm to the latest legislation text, but rather reflects</span>
<span class="sd">        the previous revision of it until (2ka) is clarified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CalculatedMinDriveEngineSpeed1st</span> <span class="o">=</span> <span class="n">IdlingEngineSpeed</span>
    <span class="n">CalculatedMinDriveEngineSpeed1stTo2nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">1.15</span> <span class="o">*</span> <span class="n">IdlingEngineSpeed</span><span class="p">)</span>
    <span class="n">CalculatedMinDriveEngineSpeed2ndDecel</span> <span class="o">=</span> <span class="n">IdlingEngineSpeed</span>
    <span class="n">CalculatedMinDriveEngineSpeed2nd</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">IdlingEngineSpeed</span>
    <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span> <span class="o">=</span> <span class="n">IdlingEngineSpeed</span> <span class="o">+</span> <span class="mf">0.125</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">RatedEngineSpeedF</span> <span class="o">-</span> <span class="n">IdlingEngineSpeed</span>
    <span class="p">)</span>

    <span class="n">MinDrive1st</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="nb">max</span><span class="p">(</span><span class="n">CalculatedMinDriveEngineSpeed1st</span><span class="p">,</span> <span class="n">MinDriveEngineSpeed1st</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">MinDrive1stTo2nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="nb">max</span><span class="p">(</span><span class="n">CalculatedMinDriveEngineSpeed1stTo2nd</span><span class="p">,</span> <span class="n">MinDriveEngineSpeed1stTo2nd</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">MinDrive2ndDecel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="nb">max</span><span class="p">(</span><span class="n">CalculatedMinDriveEngineSpeed2ndDecel</span><span class="p">,</span> <span class="n">MinDriveEngineSpeed2ndDecel</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">MinDrive2nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="nb">max</span><span class="p">(</span><span class="n">CalculatedMinDriveEngineSpeed2nd</span><span class="p">,</span> <span class="n">MinDriveEngineSpeed2nd</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">MinDriveGreater2nd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="nb">max</span><span class="p">(</span><span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">,</span> <span class="n">MinDriveEngineSpeedGreater2nd</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">NoOfGears</span> <span class="o">=</span> <span class="n">NoOfGearsFinal</span>

    <span class="n">MinDrivesI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">TraceTimesCount</span><span class="p">,</span> <span class="n">NoOfGears</span><span class="p">))</span>
    <span class="n">MinDrivesI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDrive1st</span>
    <span class="n">MinDrivesI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDrive2nd</span>
    <span class="n">MinDrivesI</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDriveGreater2nd</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">MinDrivesI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationToStandstill</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">MinDrive2ndDecel</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">MinDrivesI</span><span class="p">,</span>
        <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">,</span>
        <span class="n">MinDrive1stTo2nd</span><span class="p">,</span>
        <span class="n">MinDrive1st</span><span class="p">,</span>
        <span class="n">MinDrive2ndDecel</span><span class="p">,</span>
        <span class="n">MinDrive2nd</span><span class="p">,</span>
        <span class="n">MinDriveGreater2nd</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_accelerations"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.get_accelerations">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Accelerations&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_accelerations</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">,</span> <span class="n">TraceTimes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate accelerations.</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: array</span>

<span class="sd">    :param TraceTimes:</span>
<span class="sd">        Times for each vehicle speed required re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimes: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - Accelerations (:py:class:`numpy.array`):</span>
<span class="sd">            The acceleration required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Accelerations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">TraceTimes</span><span class="p">)),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">Accelerations</span></div>


<span class="k">def</span> <span class="nf">_check_minimum_engine_speed</span><span class="p">(</span>
    <span class="n">MinDrivesI</span><span class="p">,</span>
    <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2ndAccel</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2ndDecel</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2ndAccelStartPhase</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2ndDecelStartPhase</span><span class="p">,</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
    <span class="n">TimeEndOfStartPhase</span><span class="p">,</span>
    <span class="n">TraceTimes</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">Accelerations</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">check</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">MinDriveEngineSpeedGreater2ndAccel</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;MinDriveEngineSpeedGreater2ndAccel value </span><span class="si">%f</span><span class="s2"> must be less or equal &quot;</span>
            <span class="s2">&quot;2 * m_min_drive_set = </span><span class="si">%f</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">MinDriveEngineSpeedGreater2ndAccel</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">MinDriveEngineSpeedGreater2ndDecel</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;MinDriveEngineSpeedGreater2ndDecel value </span><span class="si">%f</span><span class="s2"> must be less or equal &quot;</span>
            <span class="s2">&quot;2 * m_min_drive_set = </span><span class="si">%f</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">MinDriveEngineSpeedGreater2ndDecel</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">MinDriveEngineSpeedGreater2ndDecelStartPhase</span>
        <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span>
    <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;MinDriveEngineSpeedGreater2ndDecel value </span><span class="si">%f</span><span class="s2"> must be less or equal &quot;</span>
            <span class="s2">&quot;2 * m_min_drive_set = </span><span class="si">%f</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">MinDriveEngineSpeedGreater2ndDecelStartPhase</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">MinDriveEngineSpeedGreater2ndAccelStartPhase</span>
        <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span>
    <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;MinDriveEngineSpeedGreater2ndDecel value </span><span class="si">%f</span><span class="s2"> must be less or equal &quot;</span>
            <span class="s2">&quot;2 * m_min_drive_set = </span><span class="si">%f</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">MinDriveEngineSpeedGreater2ndDecel</span><span class="p">,</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">InStandstillMinDrive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InStandstillMinDrive</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">TimeEndOfStartPhase</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span>
        <span class="n">InStandstillMinDrive</span><span class="p">[</span><span class="n">TimeEndOfStartPhase</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Vehicle speed at end of start phase must be zero&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>


<div class="viewcode-block" id="define_minimum_engine_speed_in_motion"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.define_minimum_engine_speed_in_motion">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;MinDrives&quot;</span><span class="p">],</span> <span class="n">input_domain</span><span class="o">=</span><span class="n">_check_minimum_engine_speed</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">define_minimum_engine_speed_in_motion</span><span class="p">(</span>
    <span class="n">MinDrivesI</span><span class="p">,</span>
    <span class="n">CalculatedMinDriveEngineSpeedGreater2nd</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2ndAccel</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2ndDecel</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2ndAccelStartPhase</span><span class="p">,</span>
    <span class="n">MinDriveEngineSpeedGreater2ndDecelStartPhase</span><span class="p">,</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
    <span class="n">TimeEndOfStartPhase</span><span class="p">,</span>
    <span class="n">TraceTimes</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">Accelerations</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the gear, in which the maximum vehicle speed is reached (2i)</span>
<span class="sd">    The maximum vehicle speed is defined as the vehicle speed, at which the</span>
<span class="sd">    available power equals the road load power caused by friction and</span>
<span class="sd">    aerodynamics, and is usually not covered by typical traces. That is why</span>
<span class="sd">    the calculation is based on sufficient fictive road load speeds.</span>

<span class="sd">    :param MinDrivesI:</span>
<span class="sd">        Minimum engine speeds when vehicle is in motion</span>
<span class="sd">    :type MinDrivesI: array</span>

<span class="sd">    :param CalculatedMinDriveEngineSpeedGreater2nd:</span>
<span class="sd">        The minimum drive engine speed grater than second</span>
<span class="sd">    :type CalculatedMinDriveEngineSpeedGreater2nd: float</span>

<span class="sd">    :param MinDriveEngineSpeedGreater2ndAccel:</span>
<span class="sd">        Annex 2 (2j) n_min_drive_up</span>
<span class="sd">        Values higher than n_min_drive_set may be used for n_gear &gt; 2.</span>
<span class="sd">        The manufacturer may specify a value</span>
<span class="sd">        for acceleration/constant speed phases (n_min_drive_up).</span>
<span class="sd">    :type MinDriveEngineSpeedGreater2ndAccel: float</span>

<span class="sd">    :param MinDriveEngineSpeedGreater2ndDecel:</span>
<span class="sd">        Annex 2 (2j) n_min_drive_down</span>
<span class="sd">        Values higher than n_min_drive_set may be used for n_gear &gt; 2.</span>
<span class="sd">        The manufacturer may specify a value</span>
<span class="sd">        for deceleration phases (n_min_drive_down).</span>
<span class="sd">    :type MinDriveEngineSpeedGreater2ndDecel: float</span>

<span class="sd">    :param MinDriveEngineSpeedGreater2ndAccelStartPhase:</span>
<span class="sd">        Annex 2 (2j) n_min_drive_up_start</span>
<span class="sd">        Heinz Steven Tool n_min_drive_start_up</span>
<span class="sd">        For an initial period of time (t_start_phase),</span>
<span class="sd">        the manufacturer may specify higher values</span>
<span class="sd">        (n_min_drive_start and/or n_min_drive_up_start)</span>
<span class="sd">        for the values n_min_drive and/or n_min_drive_up</span>
<span class="sd">        for n_gear &gt; 2.</span>
<span class="sd">        This requirement was implemented with other parameters</span>
<span class="sd">        by the reference implementation Heinz Steven Tool.</span>
<span class="sd">    :type MinDriveEngineSpeedGreater2ndAccelStartPhase: float</span>

<span class="sd">    :param MinDriveEngineSpeedGreater2ndDecelStartPhase:</span>
<span class="sd">        Annex 2 (2j) n_min_drive_start</span>
<span class="sd">        Heinz Steven Tool n_min_drive_start_down</span>
<span class="sd">        For an initial period of time (t_start_phase),</span>
<span class="sd">        the manufacturer may specify higher values</span>
<span class="sd">        (n_min_drive_start and/or n_min_drive_up_start)</span>
<span class="sd">        for the values n_min_drive and/or n_min_drive_up</span>
<span class="sd">        for n_gear &gt; 2.</span>
<span class="sd">        This requirement was implemented with other parameters</span>
<span class="sd">        by the reference implementation Heinz Steven Tool.</span>
<span class="sd">    :type MinDriveEngineSpeedGreater2ndDecelStartPhase: float</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: numpy.array</span>

<span class="sd">    :param TimeEndOfStartPhase:</span>
<span class="sd">        Annex 2 (2j) t_start_phase</span>
<span class="sd">        For an initial period of time (t_start_phase),</span>
<span class="sd">        the manufacturer may specify higher values</span>
<span class="sd">        (n_min_drive_start and/or n_min_drive_up_start)</span>
<span class="sd">        for the values n_min_drive and/or n_min_drive_up</span>
<span class="sd">        for n_gear &gt; 2.</span>
<span class="sd">        The input parameter here is used in combination with</span>
<span class="sd">        MinDriveEngineSpeedGreater2ndAccelStartPhase and</span>
<span class="sd">        MinDriveEngineSpeedGreater2ndDecelStartPhase.</span>
<span class="sd">    :type TimeEndOfStartPhase: numpy.array</span>

<span class="sd">    :param TraceTimes:</span>
<span class="sd">        Times for each vehicle speed required re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimes: numpy.array</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :param Accelerations:</span>
<span class="sd">         The acceleration required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type Accelerations: numpy.array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - MinDrives (:py:class:`numpy.array`):</span>
<span class="sd">            Samples which have acceleration values &gt;= -0.1389 m/s² ( = 0.5 (km/h)/s )</span>
<span class="sd">            shall belong to the acceleration/constant speed phases.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NoOfGears</span> <span class="o">=</span> <span class="n">NoOfGearsFinal</span>

    <span class="n">InAccelerationMinDrive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Accelerations</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InAccelerationMinDrive</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Accelerations</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.1389</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">InDecelerationMinDrive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Accelerations</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InDecelerationMinDrive</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Accelerations</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.1389</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">MinDrives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">MinDrivesI</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">MinDrives</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAccelerationMinDrive</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">MinDrives</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAccelerationMinDrive</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">],</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">MinDriveEngineSpeedGreater2ndAccel</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">MinDrives</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationMinDrive</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">MinDrives</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationMinDrive</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">],</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">MinDriveEngineSpeedGreater2ndDecel</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">InAccelerationMinDriveStartPhase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">InAccelerationMinDrive</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">InAccelerationMinDriveStartPhase</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TraceTimes</span> <span class="o">&lt;=</span> <span class="n">TimeEndOfStartPhase</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAccelerationMinDrive</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">MinDrives</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAccelerationMinDriveStartPhase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">MinDrives</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAccelerationMinDriveStartPhase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">],</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">MinDriveEngineSpeedGreater2ndAccelStartPhase</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">InDecelerationMinDriveStartPhase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">InAccelerationMinDrive</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">InDecelerationMinDriveStartPhase</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TraceTimes</span> <span class="o">&lt;=</span> <span class="n">TimeEndOfStartPhase</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationMinDrive</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">MinDrives</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationMinDriveStartPhase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">MinDrives</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationMinDriveStartPhase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span><span class="n">NoOfGears</span><span class="p">],</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">MinDriveEngineSpeedGreater2ndDecelStartPhase</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">MinDrives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">MinDrives</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">MinDrives</span></div>


<div class="viewcode-block" id="determine_gear_in_maximum_vehicle_speed"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.determine_gear_in_maximum_vehicle_speed">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GearAtMaxVehicleSpeed&quot;</span><span class="p">,</span> <span class="s2">&quot;MaxVehicleSpeed&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">determine_gear_in_maximum_vehicle_speed</span><span class="p">(</span>
    <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
    <span class="n">f0</span><span class="p">,</span>
    <span class="n">f1</span><span class="p">,</span>
    <span class="n">f2</span><span class="p">,</span>
    <span class="n">NdvRatios</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">PowerCurvePowers</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The maximum vehicle speed is defined as the vehicle speed, at which the</span>
<span class="sd">    available power equals the road load power caused by friction and</span>
<span class="sd">    aerodynamics, and is usually not covered by typical traces. That is why</span>
<span class="sd">    the calculation is based on sufficient fictive road load speeds.</span>

<span class="sd">    :param PowerCurveEngineSpeeds:</span>
<span class="sd">        Contains the power curve engine speeds</span>
<span class="sd">    :type PowerCurveEngineSpeeds: numpy.array</span>

<span class="sd">    :param f0:</span>
<span class="sd">        The constant road load coefficient,</span>
<span class="sd">        i.e. independent of velocity, caused by internal frictional resistances.</span>
<span class="sd">    :type f0: float</span>

<span class="sd">    :param f1:</span>
<span class="sd">        The linear road load coefficient,</span>
<span class="sd">        i.e. proportional to velocity, caused by tyres rolling resistances.</span>
<span class="sd">    :type f1: float</span>

<span class="sd">    :param f2:</span>
<span class="sd">        The quadratic road load coefficient,</span>
<span class="sd">        i.e. quadratical to velocity, caused by aerodynamic resistances.</span>
<span class="sd">    :type f2: float</span>

<span class="sd">    :param NdvRatios:</span>
<span class="sd">        The ratio obtained by dividing the engine speed n by the vehicle speed v</span>
<span class="sd">        for each gear i form 1 to ng after apply the exclusion of first gear if</span>
<span class="sd">        is necessary.</span>
<span class="sd">    :type NdvRatios: numpy.array</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :param PowerCurvePowers:</span>
<span class="sd">        Contains the power curve powers</span>
<span class="sd">    :type PowerCurvePowers: numpy.array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - MinDrives (:py:class:`float`):</span>
<span class="sd">            The gear that have the maximum vehicle speed</span>
<span class="sd">        - MaxVehicleSpeed (:py:class:`float`):</span>
<span class="sd">            The maximum vehicle speed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

    <span class="n">RoadLoadSpeeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">500.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">RoadLoadPowers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">f0</span> <span class="o">*</span> <span class="n">RoadLoadSpeeds</span>
            <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">RoadLoadSpeeds</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">RoadLoadSpeeds</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">/</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">NoOfGears</span> <span class="o">=</span> <span class="n">NoOfGearsFinal</span>

    <span class="n">PowerCurveVehicleSpeedsPerGear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">NdvRatios</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

    <span class="c1"># Reduce the values of the power curve by 10%</span>
    <span class="n">AvailablePowersPerGear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NoOfGears</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">RoadLoadSpeeds</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGears</span><span class="p">):</span>
        <span class="n">AvailablePowersPerGear</span><span class="p">[</span><span class="n">gear</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="n">PowerCurveVehicleSpeedsPerGear</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">PowerCurvePowers</span><span class="p">,</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">RoadLoadSpeeds</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">NextRoadLoadPowers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RoadLoadPowers</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">NextAvailablePowersPerGear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">AvailablePowersPerGear</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NoOfGears</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">VehicleSpeedsPerGear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NoOfGears</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGears</span><span class="p">):</span>
        <span class="n">VehicleSpeedsPerGear</span><span class="p">[</span><span class="n">gear</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">RoadLoadSpeeds</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">setxor1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RoadLoadPowers</span> <span class="o">&lt;</span> <span class="n">AvailablePowersPerGear</span><span class="p">[</span><span class="n">gear</span><span class="p">,</span> <span class="p">:]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">NextRoadLoadPowers</span> <span class="o">&lt;</span> <span class="n">NextAvailablePowersPerGear</span><span class="p">[</span><span class="n">gear</span><span class="p">,</span> <span class="p">:]),</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="n">GearAtMaxVehicleSpeed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NoOfGears</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">VehicleSpeedsPerGear</span><span class="p">[</span><span class="n">gear</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">VehicleSpeedsPerGear</span><span class="p">[</span><span class="n">gear</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">VehicleSpeedsPerGear</span><span class="p">[</span><span class="n">gear</span><span class="p">,</span> <span class="p">:])</span>
            <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">VehicleSpeedsPerGear</span><span class="p">[</span><span class="n">gear</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="p">):</span>
            <span class="n">GearAtMaxVehicleSpeed</span> <span class="o">=</span> <span class="n">gear</span>
            <span class="n">MaxVehicleSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">VehicleSpeedsPerGear</span><span class="p">[</span><span class="n">gear</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">GearAtMaxVehicleSpeed</span><span class="p">,</span> <span class="n">MaxVehicleSpeed</span></div>


<span class="k">def</span> <span class="nf">_check_gear_max_vehicle_speed</span><span class="p">(</span>
    <span class="n">EngineSpeedLimitVMax</span><span class="p">,</span>
    <span class="n">Max95EngineSpeedFinal</span><span class="p">,</span>
    <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
    <span class="n">PowerCurvePowers</span><span class="p">,</span>
    <span class="n">RatedEnginePowerF</span><span class="p">,</span>
    <span class="n">NdvRatios</span><span class="p">,</span>
    <span class="n">GearAtMaxVehicleSpeed</span><span class="p">,</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
    <span class="n">MaxVehicleSpeed</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">if</span> <span class="n">GearAtMaxVehicleSpeed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Gear to be used at maximum vehicle speed could not be determined&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="determine_maximum_engine_speed"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.determine_maximum_engine_speed">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span>
    <span class="n">dsp</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;MaxEngineSpeed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GearAtMaxVehicleSpeedFinal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MaxVehicleSpeedFinal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;EngineSpeedAtGearAtMaxRequiredSpeed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;EngineSpeedAtGearAtMaxVehicleSpeed&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">input_domain</span><span class="o">=</span><span class="n">_check_gear_max_vehicle_speed</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">determine_maximum_engine_speed</span><span class="p">(</span>
    <span class="n">EngineSpeedLimitVMax</span><span class="p">,</span>
    <span class="n">Max95EngineSpeedFinal</span><span class="p">,</span>
    <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
    <span class="n">PowerCurvePowers</span><span class="p">,</span>
    <span class="n">RatedEnginePowerF</span><span class="p">,</span>
    <span class="n">NdvRatios</span><span class="p">,</span>
    <span class="n">GearAtMaxVehicleSpeed</span><span class="p">,</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
    <span class="n">MaxVehicleSpeed</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine maximum engine speed (2g)</span>

<span class="sd">    n_max1 = n_95_high</span>

<span class="sd">    If n_95_high cannot be determined</span>
<span class="sd">    because the engine speed is limited to a lower value n_lim for all gears</span>
<span class="sd">    and the corresponding full load power is higher than 95 per cent of rated power,</span>
<span class="sd">    n_95_high shall be set to n_lim.</span>

<span class="sd">    :param EngineSpeedLimitVMax:</span>
<span class="sd">        Annex 2, (2i) n_lim</span>
<span class="sd">        The maximum engine speed for the purpose of limiting maximum vehicle speed.</span>
<span class="sd">        (value 0 means unlimited vehicle speed)</span>
<span class="sd">    :type EngineSpeedLimitVMax: float</span>

<span class="sd">    :param Max95EngineSpeedFinal:</span>
<span class="sd">         Annex 2 (2g) n_max1 = n_95_high adjusted</span>
<span class="sd">         If n_95_high cannot be determined because the engine speed is limited to</span>
<span class="sd">         a lower value n_lim for all gears and the corresponding full load power</span>
<span class="sd">         is higher than 95 per cent of rated power, n_95_high shall be set to n_lim.</span>
<span class="sd">    :type Max95EngineSpeedFinal: float</span>

<span class="sd">    :param PowerCurveEngineSpeeds:</span>
<span class="sd">        Contains the power curve engine speeds</span>
<span class="sd">    :type PowerCurveEngineSpeeds: numpy.array</span>

<span class="sd">    :param PowerCurvePowers:</span>
<span class="sd">        Contains the power curve powers</span>
<span class="sd">    :type PowerCurvePowers: numpy.array</span>

<span class="sd">    :param RatedEnginePowerF:</span>
<span class="sd">        Contains the rated engine power corrected if is necessary</span>
<span class="sd">    :type RatedEnginePowerF: float</span>

<span class="sd">    :param NdvRatios:</span>
<span class="sd">        The ratio obtained by dividing the engine speed n by the vehicle speed v</span>
<span class="sd">        for each gear i form 1 to ng after apply the exclusion of first gear if</span>
<span class="sd">        is necessary.</span>
<span class="sd">    :type NdvRatios: numpy.array</span>

<span class="sd">    :param GearAtMaxVehicleSpeed:</span>
<span class="sd">        The gear that have the maximum vehicle speed</span>
<span class="sd">    :type GearAtMaxVehicleSpeed: float</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: numpy.array</span>

<span class="sd">    :param MaxVehicleSpeed:</span>
<span class="sd">        The maximum vehicle speed</span>
<span class="sd">    :type MaxVehicleSpeed: float</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: int</span>

<span class="sd">    :returns:</span>
<span class="sd">        - MaxEngineSpeed (:py:class:`float`):</span>
<span class="sd">            The maximum engine speed</span>
<span class="sd">        - GearAtMaxVehicleSpeedFinal (:py:class:`int`):</span>
<span class="sd">            Annex 2 (2i) ng_vmax</span>
<span class="sd">            The gear in which the maximum vehicle speed is reached.</span>
<span class="sd">        - MaxVehicleSpeedFinal (:py:class:`float`):</span>
<span class="sd">            Annex 2 (2g, 2i) v_max,vehicle</span>
<span class="sd">            The maximum vehicle speed reachable</span>
<span class="sd">            using the gear in which the maximum vehicle speed can be reached.</span>
<span class="sd">        - EngineSpeedAtGearAtMaxRequiredSpeed (:py:class:`float`):</span>
<span class="sd">            The engine speed at gear maximum required speed</span>
<span class="sd">        - EngineSpeedAtGearAtMaxVehicleSpeed (:py:class:`float`):</span>
<span class="sd">            The engine speed at gear at maximum vehicle speed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NoOfGears</span> <span class="o">=</span> <span class="n">NoOfGearsFinal</span>

    <span class="k">if</span> <span class="n">EngineSpeedLimitVMax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">EngineSpeedLimitVMax</span> <span class="o">&lt;</span> <span class="n">Max95EngineSpeedFinal</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

        <span class="n">PowerAtEngineSpeedLimitVMax</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span> <span class="n">PowerCurvePowers</span>
        <span class="p">)(</span><span class="n">EngineSpeedLimitVMax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PowerAtEngineSpeedLimitVMax</span> <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">RatedEnginePowerF</span><span class="p">:</span>
            <span class="n">Max95EngineSpeedFinal</span> <span class="o">=</span> <span class="n">EngineSpeedLimitVMax</span>

    <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span> <span class="o">=</span> <span class="n">NdvRatios</span><span class="p">[</span><span class="n">GearAtMaxVehicleSpeed</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
        <span class="n">RequiredVehicleSpeeds</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">EngineSpeedLimitVMax</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="ow">and</span> <span class="n">EngineSpeedLimitVMax</span> <span class="o">&lt;</span> <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span>
    <span class="p">):</span>
        <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span> <span class="o">=</span> <span class="n">EngineSpeedLimitVMax</span>

    <span class="n">EngineSpeedAtGearAtMaxVehicleSpeed</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">NdvRatios</span><span class="p">[</span><span class="n">GearAtMaxVehicleSpeed</span><span class="p">]</span> <span class="o">*</span> <span class="n">MaxVehicleSpeed</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">EngineSpeedLimitVMax</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="ow">and</span> <span class="n">EngineSpeedLimitVMax</span> <span class="o">&lt;</span> <span class="n">EngineSpeedAtGearAtMaxVehicleSpeed</span>
    <span class="p">):</span>
        <span class="n">EngineSpeedAtGearAtMaxVehicleSpeed</span> <span class="o">=</span> <span class="n">EngineSpeedLimitVMax</span>
        <span class="n">GearAtMaxVehicleSpeed</span> <span class="o">=</span> <span class="n">NoOfGears</span>
        <span class="n">MaxVehicleSpeed</span> <span class="o">=</span> <span class="n">EngineSpeedLimitVMax</span> <span class="o">/</span> <span class="n">NdvRatios</span><span class="p">(</span><span class="n">NoOfGears</span><span class="p">)</span>

    <span class="n">MaxEngineSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">Max95EngineSpeedFinal</span><span class="p">,</span>
            <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span><span class="p">,</span>
            <span class="n">EngineSpeedAtGearAtMaxVehicleSpeed</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">GearAtMaxVehicleSpeedFinal</span> <span class="o">=</span> <span class="n">GearAtMaxVehicleSpeed</span>

    <span class="n">MaxVehicleSpeedFinal</span> <span class="o">=</span> <span class="n">MaxVehicleSpeed</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">MaxEngineSpeed</span><span class="p">,</span>
        <span class="n">GearAtMaxVehicleSpeedFinal</span><span class="p">,</span>
        <span class="n">MaxVehicleSpeedFinal</span><span class="p">,</span>
        <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span><span class="p">,</span>
        <span class="n">EngineSpeedAtGearAtMaxVehicleSpeed</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="calculate_required_powers"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.calculate_required_powers">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;requiredPowersF&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">calculate_required_powers</span><span class="p">(</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span> <span class="n">Accelerations</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">VehicleTestMass</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate required powers (3.1)</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: array</span>

<span class="sd">    :param Accelerations:</span>
<span class="sd">         The acceleration required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type Accelerations: array</span>

<span class="sd">    :param f0:</span>
<span class="sd">        The constant road load coefficient,</span>
<span class="sd">        i.e. independent of velocity, caused by internal frictional resistances.</span>
<span class="sd">    :type f0: float</span>

<span class="sd">    :param f1:</span>
<span class="sd">        The linear road load coefficient,</span>
<span class="sd">        i.e. proportional to velocity, caused by tyres rolling resistances.</span>
<span class="sd">    :type f1: float</span>

<span class="sd">    :param f2:</span>
<span class="sd">        The quadratic road load coefficient,</span>
<span class="sd">        i.e. quadratical to velocity, caused by aerodynamic resistances.</span>
<span class="sd">    :type f2: float</span>

<span class="sd">    :param VehicleTestMass:</span>
<span class="sd">        The test mass of the vehicle.</span>
<span class="sd">    :type VehicleTestMass: float</span>

<span class="sd">    :returns:</span>
<span class="sd">        - requiredPowersF (:py:class:`float`):</span>
<span class="sd">            Annex 2 (3.1) P_required,j</span>
<span class="sd">            The power required to overcome driving resistance and to accelerate</span>
<span class="sd">            for each second j of the cycle trace.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">requiredPowers</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">f0</span> <span class="o">*</span> <span class="n">RequiredVehicleSpeeds</span>
        <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="o">+</span> <span class="mf">1.03</span> <span class="o">*</span> <span class="n">Accelerations</span> <span class="o">*</span> <span class="n">RequiredVehicleSpeeds</span> <span class="o">*</span> <span class="n">VehicleTestMass</span>
    <span class="p">)</span>
    <span class="n">requiredPowersF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">requiredPowers</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">requiredPowersF</span></div>


<div class="viewcode-block" id="determine_possible_gears"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.determine_possible_gears">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span>
    <span class="n">dsp</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;RequiredEngineSpeeds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;InitialRequiredEngineSpeeds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PossibleGearsByEngineSpeed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AccelerationFromStandstillStarts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ClutchDisengagedByGear&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ClutchUndefinedByGear&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ClutchDisengaged&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ClutchUndefined&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AdvancedClutchDisengage&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">determine_possible_gears</span><span class="p">(</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
    <span class="n">NdvRatios</span><span class="p">,</span>
    <span class="n">TraceTimesCount</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">PhaseValues</span><span class="p">,</span>
    <span class="n">InStandStill</span><span class="p">,</span>
    <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
    <span class="n">PhaseStarts</span><span class="p">,</span>
    <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">,</span>
    <span class="n">Accelerations</span><span class="p">,</span>
    <span class="n">MinDrives</span><span class="p">,</span>
    <span class="n">GearAtMaxVehicleSpeedFinal</span><span class="p">,</span>
    <span class="n">Max95EngineSpeedFinal</span><span class="p">,</span>
    <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span><span class="p">,</span>
    <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
    <span class="n">InDecelerationToStandstill</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine possible gears based on required engine speeds (3.3)</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: array</span>

<span class="sd">    :param NdvRatios:</span>
<span class="sd">        The ratio obtained by dividing the engine speed n by the vehicle speed v</span>
<span class="sd">        for each gear i form 1 to ng after apply the exclusion of first gear if</span>
<span class="sd">        is necessary.</span>
<span class="sd">    :type NdvRatios: array</span>

<span class="sd">    :param TraceTimesCount:</span>
<span class="sd">        The length of trace times re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimesCount: integer</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :param PhaseValues:</span>
<span class="sd">        Contains the points of changes phases</span>
<span class="sd">    :type PhaseValues: array</span>

<span class="sd">    :param InStandStill:</span>
<span class="sd">        Contains the points that are in standstill phase as a True</span>
<span class="sd">    :type InStandStill: boolean array</span>

<span class="sd">    :param IdlingEngineSpeed:</span>
<span class="sd">        Annex 2 (2c) n_idle. The idling speed.</span>
<span class="sd">    :type IdlingEngineSpeed: float</span>

<span class="sd">    :param PhaseStarts:</span>
<span class="sd">        Contains the points that are start point from a phase</span>
<span class="sd">    :type PhaseStarts: array</span>

<span class="sd">    :param PHASE_ACCELERATION_FROM_STANDSTILL:</span>
<span class="sd">        Acceleration phase following a standstill phase</span>
<span class="sd">    :type PHASE_ACCELERATION_FROM_STANDSTILL: integer</span>

<span class="sd">    :param Accelerations:</span>
<span class="sd">         The acceleration required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type Accelerations: array</span>

<span class="sd">    :param MinDrives:</span>
<span class="sd">        Samples which have acceleration values &gt;= -0.1389 m/s² ( = 0.5 (km/h)/s )</span>
<span class="sd">        shall belong to the acceleration/constant speed phases.</span>
<span class="sd">    :type MinDrives: array</span>

<span class="sd">    :param GearAtMaxVehicleSpeedFinal:</span>
<span class="sd">        Annex 2 (2i) ng_vmax</span>
<span class="sd">        The gear in which the maximum vehicle speed is reached.</span>
<span class="sd">    :type GearAtMaxVehicleSpeedFinal: integer</span>

<span class="sd">    :param Max95EngineSpeedFinal:</span>
<span class="sd">         Annex 2 (2g) n_max1 = n_95_high adjusted</span>
<span class="sd">         If n_95_high cannot be determined because the engine speed is limited to</span>
<span class="sd">         a lower value n_lim for all gears and the corresponding full load power</span>
<span class="sd">         is higher than 95 per cent of rated power, n_95_high shall be set to n_lim.</span>
<span class="sd">    :type Max95EngineSpeedFinal: float</span>

<span class="sd">    :param EngineSpeedAtGearAtMaxRequiredSpeed:</span>
<span class="sd">        The engine speed at gear maximum required speed</span>
<span class="sd">    :type EngineSpeedAtGearAtMaxRequiredSpeed: float</span>

<span class="sd">    :param PowerCurveEngineSpeeds:</span>
<span class="sd">        Contains the power curve engine speeds</span>
<span class="sd">    :type PowerCurveEngineSpeeds: array</span>

<span class="sd">    :param InDecelerationToStandstill:</span>
<span class="sd">        The array that contains the seconds from deceleration to standstill as a True</span>
<span class="sd">    :type InDecelerationToStandstill: boolean array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - RequiredEngineSpeeds (:py:class:`numpy.array`):</span>
<span class="sd">            Annex 2 (3.2) n_i,j</span>
<span class="sd">            The engine speeds required</span>
<span class="sd">            for each gear i from 1 to ng and</span>
<span class="sd">            for each second j of the cycle trace.</span>
<span class="sd">            .. note::  Note that this are the uncorrected values n_i,j</span>
<span class="sd">                i.e. without the increments required by Annex 2 (3.3)</span>
<span class="sd">        - InitialRequiredEngineSpeeds (:py:class:`numpy.array`):</span>
<span class="sd">            The initial engine speeds required for each gear i from 1 to ng and</span>
<span class="sd">            for each second j of the cycle trace.</span>
<span class="sd">        - PossibleGearsByEngineSpeed (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The possible gear that can be used for each second.</span>
<span class="sd">        - AccelerationFromStandstillStarts (:py:class:`numpy.array`):</span>
<span class="sd">            The phase start seconds when the phase is going to acceleration</span>
<span class="sd">            from stand still.</span>
<span class="sd">        - ClutchDisengagedByGear (:py:class:`numpy.array`):</span>
<span class="sd">            The clutch disengaged by each gear and each second.</span>
<span class="sd">        - ClutchUndefinedByGear (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The clutch undefined by each gear and each second.</span>
<span class="sd">        - ClutchDisengaged (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The clutch disengaged by each second.</span>
<span class="sd">        - ClutchUndefined (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The clutch undefined by each second.</span>
<span class="sd">        - AdvancedClutchDisengage (:py:class:`list`):</span>
<span class="sd">            The seconds in which the advanced clutch disengaget</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

    <span class="n">RequiredEngineSpeeds</span> <span class="o">=</span> <span class="n">NdvRatios</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">InitialRequiredEngineSpeeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">)</span>

    <span class="n">PossibleGearsByEngineSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">TraceTimesCount</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">))</span>
    <span class="n">PossibleGearsByEngineSpeed</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">ClutchDisengaged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">TraceTimesCount</span><span class="p">)</span>
    <span class="n">ClutchUndefined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">TraceTimesCount</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStill</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">PossibleGearsByEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStill</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">AccelerationFromStandstillStarts</span> <span class="o">=</span> <span class="n">PhaseStarts</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">BeforeAccelerationStarts</span> <span class="o">=</span> <span class="n">AccelerationFromStandstillStarts</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">BeforeAccelerationStarts</span><span class="p">)):</span>
        <span class="k">while</span> <span class="p">(</span>
            <span class="n">BeforeAccelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span>
            <span class="ow">and</span> <span class="n">Accelerations</span><span class="p">[</span><span class="n">BeforeAccelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">BeforeAccelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BeforeAccelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">AdvancedFirstGearEngage</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">AccelerationFromStandstillStarts</span><span class="p">)):</span>
        <span class="n">AdvancedFirstGearEngage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">BeforeAccelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AccelerationFromStandstillStarts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">AdvancedClutchDisengage</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">BeforeAccelerationStarts</span><span class="p">)):</span>
        <span class="n">AdvancedClutchDisengage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">BeforeAccelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BeforeAccelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">first_gear</span> <span class="ow">in</span> <span class="n">AdvancedFirstGearEngage</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">PossibleGearsByEngineSpeed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">first_gear</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ClutchDisengaged</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">first_gear</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gear</span> <span class="o">&lt;</span> <span class="n">GearAtMaxVehicleSpeedFinal</span><span class="p">:</span>
            <span class="c1"># 3.3a</span>
            <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">PossibleGearsByEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
                <span class="n">reduce</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MinDrives</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Max95EngineSpeedFinal</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 3.3b</span>
            <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">PossibleGearsByEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
                <span class="n">reduce</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">MinDrives</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span>
                            <span class="o">&lt;=</span> <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># 3.3c</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">PossibleGearsByEngineSpeed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MinDrives</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ClutchDisengagedByGear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">TraceTimesCount</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">))</span>
    <span class="n">ClutchUndefinedByGear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">TraceTimesCount</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">))</span>

    <span class="n">InAnyStandStill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">InAnyStandStill</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">InAnyDeceleration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">InAnyDeceleration</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyStandStill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">InAnyAcceleration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">InAnyAcceleration</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="o">+</span><span class="mf">0.001</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyStandStill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">InAnyConstantSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">InAnyConstantSpeed</span><span class="p">,</span>
        <span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyStandStill</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyDeceleration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyAcceleration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">InAnyDecelerationWithLowEngineSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">),</span> <span class="n">NoOfGearsFinal</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">InAnyDecelerationWithLowEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyDeceleration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">IdlingEngineSpeed</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">ClutchDisengagedByGear</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyDecelerationWithLowEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyDecelerationWithLowEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">),</span> <span class="n">NoOfGearsFinal</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyAcceleration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span>
                    <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="mf">1.15</span> <span class="o">*</span> <span class="n">IdlingEngineSpeed</span><span class="p">,</span> <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">ClutchDisengagedByGear</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">ClutchUndefinedByGear</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">RequiredEngineSpeedsBefore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="mf">1.15</span> <span class="o">*</span> <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                        <span class="n">RequiredEngineSpeeds</span><span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                <span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeed</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="p">),</span>
                            <span class="n">gear</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeedModified</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
        <span class="n">RequiredEngineSpeeds</span> <span class="o">-</span> <span class="n">RequiredEngineSpeedsBefore</span>
    <span class="p">)</span>
    <span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeedModified</span><span class="p">[</span>
        <span class="n">InAnyAccelOrConstSpeedWithLowEngineSpeedModified</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">Gear1WithIncrEngineSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">TraceTimesCount</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">Gear1WithIncrEngineSpeed</span><span class="p">,</span>
        <span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">InitialRequiredEngineSpeeds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationToStandstill</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ClutchDisengagedByGear</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Gear1WithIncrEngineSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">ClutchUndefinedByGear</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Gear1WithIncrEngineSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAnyDeceleration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">RequiredEngineSpeeds</span><span class="p">,</span>
        <span class="n">InitialRequiredEngineSpeeds</span><span class="p">,</span>
        <span class="n">PossibleGearsByEngineSpeed</span><span class="p">,</span>
        <span class="n">AccelerationFromStandstillStarts</span><span class="p">,</span>
        <span class="n">ClutchDisengagedByGear</span><span class="p">,</span>
        <span class="n">ClutchUndefinedByGear</span><span class="p">,</span>
        <span class="n">ClutchDisengaged</span><span class="p">,</span>
        <span class="n">ClutchUndefined</span><span class="p">,</span>
        <span class="n">AdvancedClutchDisengage</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="calculate_available_powers"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.calculate_available_powers">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AvailablePowers&quot;</span><span class="p">,</span> <span class="s2">&quot;InitialAvailablePowers&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">calculate_available_powers</span><span class="p">(</span>
    <span class="n">DefinedPowerCurveAdditionalSafetyMargins</span><span class="p">,</span>
    <span class="n">RequiredEngineSpeeds</span><span class="p">,</span>
    <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
    <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
    <span class="n">SafetyMargin</span><span class="p">,</span>
    <span class="n">PowerCurveASM</span><span class="p">,</span>
    <span class="n">PowerCurvePowers</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">InitialRequiredEngineSpeeds</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate available powers (3.4)</span>

<span class="sd">    Additional safety margins defined together with the power curve take precedence</span>
<span class="sd">    over the legacy additional safety margins exponentially decaying from start to</span>
<span class="sd">    end engine speed</span>

<span class="sd">    :param DefinedPowerCurveAdditionalSafetyMargins:</span>
<span class="sd">        Boolean that define if the additional save margins are present</span>
<span class="sd">    :type DefinedPowerCurveAdditionalSafetyMargins: boolean</span>

<span class="sd">    :param RequiredEngineSpeeds:</span>
<span class="sd">        Annex 2 (3.2) n_i,j</span>
<span class="sd">        The engine speeds required</span>
<span class="sd">        for each gear i from 1 to ng and</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">        Note that this are the uncorrected values n_i,j</span>
<span class="sd">        ie without the increments required by Annex 2 (3.3)</span>
<span class="sd">    :type RequiredEngineSpeeds: array</span>

<span class="sd">    :param IdlingEngineSpeed:</span>
<span class="sd">        Annex 2 (2c) n_idle. The idling speed.</span>
<span class="sd">    :type IdlingEngineSpeed: float</span>

<span class="sd">    :param PowerCurveEngineSpeeds:</span>
<span class="sd">        Contains the power curve engine speeds</span>
<span class="sd">    :type PowerCurveEngineSpeeds: array</span>

<span class="sd">    :param PowerCurveASM:</span>
<span class="sd">        Contains the power curve additional save margin</span>
<span class="sd">    :type PowerCurveASM: array</span>

<span class="sd">    :param PowerCurvePowers:</span>
<span class="sd">        Contains the power curve powers</span>
<span class="sd">    :type PowerCurvePowers: array</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :param InitialRequiredEngineSpeeds:</span>
<span class="sd">        The initial engine speeds required for each gear i from 1 to ng and</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">    :type InitialRequiredEngineSpeeds: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - SafetyMargin (:py:class:`float`):</span>
<span class="sd">            Annex 2 (3.4) SM. The safety margin is accounting for the difference between the</span>
<span class="sd">            stationary full load condition power curve and the power available</span>
<span class="sd">            during transition conditions.</span>
<span class="sd">            SM is set to 10 per cent.</span>
<span class="sd">        - AvailablePowers (:py:class:`numpy.array`):</span>
<span class="sd">            Annex 2 (3.4) P_available_i,j</span>
<span class="sd">            The power available for each gear i from 1 to ng and for each second j</span>
<span class="sd">            of the cycle trace. Note that this power values are determined from</span>
<span class="sd">            uncorrected values n_i,j i.e. without the engine speed increments</span>
<span class="sd">            required by Annex 2 (3.3)</span>
<span class="sd">        - InitialAvailablePowers (:py:class:`numpy.array`):</span>
<span class="sd">            Annex 2 (3.4) P_available_i,j (initials)</span>
<span class="sd">            The power available for each gear i from 1 to ng and for each second j</span>
<span class="sd">            of the cycle trace.</span>
<span class="sd">            Note that this power values are determined from uncorrected values n_i,j</span>
<span class="sd">            i.e. without the engine speed increments required by Annex 2 (3.3)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

    <span class="n">interpval</span> <span class="o">=</span> <span class="n">PowerCurvePowers</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">SafetyMargin</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">PowerCurveASM</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DefinedPowerCurveAdditionalSafetyMargins</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">IdlingEngineSpeed</span><span class="p">),</span>
            <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">AvailablePowers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">AvailablePowers</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">gear</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">AvailablePowers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                        <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
                        <span class="n">interpval</span><span class="p">,</span>
                        <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="p">)(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">RequiredEngineSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">gear</span><span class="p">],</span>
                                <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">AvailablePowers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                        <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
                        <span class="n">interpval</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                        <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
                    <span class="p">)(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">RequiredEngineSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">gear</span><span class="p">],</span>
                                <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">InitialAvailablePowers</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
            <span class="n">PowerCurvePowers</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">SafetyMargin</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">PowerCurveASM</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">InitialRequiredEngineSpeeds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">AvailablePowers</span><span class="p">,</span> <span class="n">InitialAvailablePowers</span></div>


<span class="k">def</span> <span class="nf">_sub2ind</span><span class="p">(</span><span class="n">array_shape</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">array_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>
    <span class="k">return</span> <span class="n">ind</span>


<div class="viewcode-block" id="determine_possible_gears_based_available_powers"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.determine_possible_gears_based_available_powers">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PossibleGearsByAvailablePowersWithTotalSafetyMargin&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">determine_possible_gears_based_available_powers</span><span class="p">(</span>
    <span class="n">AvailablePowers</span><span class="p">,</span>
    <span class="n">requiredPowersF</span><span class="p">,</span>
    <span class="n">TraceTimesCount</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">PossibleGearsByEngineSpeed</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine possible gears based on available powers (3.5)</span>

<span class="sd">    :param AvailablePowers:</span>
<span class="sd">        Annex 2 (3.4) P_available_i,j</span>
<span class="sd">        The power available for each gear i from 1 to ng and for each second j</span>
<span class="sd">        of the cycle trace.</span>
<span class="sd">        Note that this power values are determined from uncorrected values n_i,j</span>
<span class="sd">        i.e. without the engine speed increments required by Annex 2 (3.3)</span>
<span class="sd">    :type AvailablePowers: array</span>

<span class="sd">    :param requiredPowersF:</span>
<span class="sd">        Annex 2 (3.1) P_required,j</span>
<span class="sd">        The power required to overcome driving resistance and to accelerate</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">    :type requiredPowersF: array</span>

<span class="sd">    :param TraceTimesCount:</span>
<span class="sd">        The length of trace times re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimesCount: integer</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :returns:</span>
<span class="sd">        - PossibleGearsByEngineSpeed (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The possible gear that can be used for each second.</span>
<span class="sd">        - PossibleGearsByAvailablePowersWithTotalSafetyMargin (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The possible gears by available powers with total safety margin</span>
<span class="sd">            (following section 3.5 of Sub-Annex 2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="p">(</span><span class="n">TraceTimesCount</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AvailablePowers</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">requiredPowersF</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">AvailablePowers</span> <span class="o">*</span> <span class="n">PossibleGearsByEngineSpeed</span>
    <span class="n">K</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">K</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">AvailablePowers</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">I</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">AvailablePowers</span><span class="p">)</span>

    <span class="n">linearInd</span> <span class="o">=</span> <span class="n">_sub2ind</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">AvailablePowers</span><span class="p">),</span> <span class="n">I</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>

    <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span>
            <span class="n">linearInd</span><span class="p">,</span> <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span>
        <span class="p">)</span>
    <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span></div>


<div class="viewcode-block" id="determine_initial_gears"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.determine_initial_gears">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;InitialGears&quot;</span><span class="p">,</span> <span class="s2">&quot;PossibleGears&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">determine_initial_gears</span><span class="p">(</span>
    <span class="n">InStandStill</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">PossibleGearsByEngineSpeed</span><span class="p">,</span>
    <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span><span class="p">,</span>
    <span class="n">AccelerationFromStandstillStarts</span><span class="p">,</span>
    <span class="n">PhaseEnds</span><span class="p">,</span>
    <span class="n">PhaseValues</span><span class="p">,</span>
    <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">,</span>
    <span class="n">InitialRequiredEngineSpeeds</span><span class="p">,</span>
    <span class="n">MinDrive1stTo2nd</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine initial gears</span>

<span class="sd">    :param InStandStill:</span>
<span class="sd">        Contains the points that are in standstill phase as a True</span>
<span class="sd">    :type InStandStill: boolean array</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :param PossibleGearsByEngineSpeed:</span>
<span class="sd">        The possible gear that can be used for each second.</span>
<span class="sd">    :type PossibleGearsByEngineSpeed: boolean array</span>

<span class="sd">    :param PossibleGearsByAvailablePowersWithTotalSafetyMargin:</span>
<span class="sd">        The possible gears by available powers with total safety margin</span>
<span class="sd">        (following section 3.5 of Sub-Annex 2)</span>
<span class="sd">    :type PossibleGearsByAvailablePowersWithTotalSafetyMargin: boolean array</span>

<span class="sd">    :param AccelerationFromStandstillStarts:</span>
<span class="sd">        The phase start seconds when the phase is going to acceleration</span>
<span class="sd">        from stand still.</span>
<span class="sd">    :type AccelerationFromStandstillStarts: array</span>

<span class="sd">    :param PhaseEnds:</span>
<span class="sd">        Contains the points that are end point from a phase</span>
<span class="sd">    :type PhaseEnds: array</span>

<span class="sd">    :param PhaseValues:</span>
<span class="sd">        Contains the points of changes phases</span>
<span class="sd">    :type PhaseValues: array</span>

<span class="sd">    :param PHASE_ACCELERATION_FROM_STANDSTILL:</span>
<span class="sd">        Acceleration phase following a standstill phase</span>
<span class="sd">    :type PHASE_ACCELERATION_FROM_STANDSTILL: integer</span>

<span class="sd">    :param InitialRequiredEngineSpeeds:</span>
<span class="sd">        The initial engine speeds required for each gear i from 1 to ng and</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">    :type InitialRequiredEngineSpeeds: array</span>

<span class="sd">    :param MinDrive1stTo2nd:</span>
<span class="sd">        Annex 2 (2ka) n_min_drive = 1.15 x n_idle for n_gear:1-&gt;2</span>
<span class="sd">        The minimum engine speed for transitions from first to second gear.</span>
<span class="sd">        This is the maximum of calculated value and input parameter value.</span>
<span class="sd">    :type MinDrive1stTo2nd: float</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGears (:py:class:`numpy.array`):</span>
<span class="sd">            The initial gears calculated by each second</span>
<span class="sd">        - PossibleGears (:py:class:`numpy.array`):</span>
<span class="sd">            The possible gears calculated by each second</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">InStandStillReps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">InStandStill</span><span class="p">,</span> <span class="p">(</span><span class="n">NoOfGearsFinal</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">PossibleGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">PossibleGearsByEngineSpeed</span><span class="p">)</span>
    <span class="n">PossibleGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStillReps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">PossibleGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStillReps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="o">*</span> <span class="n">PossibleGearsByAvailablePowersWithTotalSafetyMargin</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InStandStillReps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
        <span class="n">PossibleGears</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">gear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">PossibleGears</span><span class="p">[:,</span> <span class="n">gear</span><span class="p">]</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">PossibleGears</span><span class="p">)</span>
    <span class="n">K</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">K</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">InitialGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">InitialGears</span><span class="p">[</span><span class="n">AccelerationFromStandstillStarts</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">AccelerationFromStandstillEnds</span> <span class="o">=</span> <span class="n">PhaseEnds</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">AccelerationsFromStandstill</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">AccelerationFromStandstillStarts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AccelerationFromStandstillEnds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">AccelerationFromStandstillEnds</span><span class="p">))</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">AccelerationsFromStandstill</span><span class="p">:</span>
        <span class="n">gears</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gears</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">secondGearEngaged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gears</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">gears</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">secondGearEngaged</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">gears</span>

    <span class="c1"># Changed requirement:</span>
    <span class="c1"># MinDrive1stTo2nd no longer limited to acceleration phase.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">FromGear1</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">FromGear1</span>
                <span class="ow">and</span> <span class="n">InitialRequiredEngineSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MinDrive1stTo2nd</span>
                <span class="ow">and</span> <span class="n">PossibleGears</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">FromGear1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FromGear1</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">PossibleGears</span></div>


<span class="k">def</span> <span class="nf">_next_n_gears_are_higher</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">gears</span><span class="p">):</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gears</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gears</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gears</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gears</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">gears</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">enabled</span>


<div class="viewcode-block" id="apply_corrections"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.apply_corrections">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span>
    <span class="n">dsp</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;InitialGearsFinal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CorrectionsCells&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ClutchDisengagedByGearFinal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ClutchUndefinedByGearFinal&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">apply_corrections</span><span class="p">(</span>
    <span class="n">InitialGears</span><span class="p">,</span>
    <span class="n">PhaseValues</span><span class="p">,</span>
    <span class="n">PhaseStarts</span><span class="p">,</span>
    <span class="n">PhaseEnds</span><span class="p">,</span>
    <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">,</span>
    <span class="n">PHASE_ACCELERATION</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">PossibleGears</span><span class="p">,</span>
    <span class="n">InAcceleration</span><span class="p">,</span>
    <span class="n">InConstantSpeed</span><span class="p">,</span>
    <span class="n">InAccelerationAnyDuration</span><span class="p">,</span>
    <span class="n">ClutchDisengagedByGear</span><span class="p">,</span>
    <span class="n">ClutchUndefinedByGear</span><span class="p">,</span>
    <span class="n">PHASE_DECELERATION</span><span class="p">,</span>
    <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">,</span>
    <span class="n">TraceTimesCount</span><span class="p">,</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
    <span class="n">SuppressGear0DuringDownshifts</span><span class="p">,</span>
    <span class="n">ClutchDisengaged</span><span class="p">,</span>
    <span class="n">InitialRequiredEngineSpeeds</span><span class="p">,</span>
    <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
    <span class="n">Phases</span><span class="p">,</span>
    <span class="n">InStandStill</span><span class="p">,</span>
    <span class="n">InDecelerationToStandstill</span><span class="p">,</span>
    <span class="n">InDeceleration</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply corrections defined in section 4 of the sub-Annex 2</span>

<span class="sd">    :param InitialGears:</span>
<span class="sd">        The initial gears calculated by each second</span>
<span class="sd">    :type InitialGears: array</span>

<span class="sd">    :param PhaseValues:</span>
<span class="sd">        Contains the points of changes phases</span>
<span class="sd">    :type PhaseValues: array</span>

<span class="sd">    :param PhaseStarts:</span>
<span class="sd">        Contains the points that are start point from a phase</span>
<span class="sd">    :type PhaseStarts: array</span>

<span class="sd">    :param PhaseEnds:</span>
<span class="sd">        Contains the points that are end point from a phase</span>
<span class="sd">    :type PhaseEnds: array</span>

<span class="sd">    :param PHASE_ACCELERATION_FROM_STANDSTILL:</span>
<span class="sd">        Acceleration phase following a standstill phase</span>
<span class="sd">    :type PHASE_ACCELERATION_FROM_STANDSTILL: integer</span>

<span class="sd">    :param PHASE_ACCELERATION:</span>
<span class="sd">        Acceleration phase</span>
<span class="sd">    :type PHASE_ACCELERATION: integer</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :param PossibleGears:</span>
<span class="sd">        The possible gears calculated by each second</span>
<span class="sd">    :type PossibleGears: array</span>

<span class="sd">    :param InAcceleration:</span>
<span class="sd">        Contains the points that are in acceleration phase as a True</span>
<span class="sd">    :type InAcceleration: boolean array</span>

<span class="sd">    :param InConstantSpeed:</span>
<span class="sd">        Contains the points that are in constant speed phase as a True</span>
<span class="sd">    :type InConstantSpeed: boolean array</span>

<span class="sd">    :param InAccelerationAnyDuration:</span>
<span class="sd">         some gear corrections ignore the duration of acceleration phases</span>
<span class="sd">         so save acceleration phases with any duration here</span>
<span class="sd">    :type InAccelerationAnyDuration: boolean array</span>

<span class="sd">    :param ClutchDisengagedByGear:</span>
<span class="sd">        The clutch disengaged by each gear and each second.</span>
<span class="sd">    :type ClutchDisengagedByGear: boolean array</span>

<span class="sd">    :param ClutchUndefinedByGear:</span>
<span class="sd">        The clutch undefined by each gear and each second.</span>
<span class="sd">    :type ClutchUndefinedByGear: boolean array</span>

<span class="sd">    :param PHASE_DECELERATION:</span>
<span class="sd">        time period of more than 2 seconds with required vehicle</span>
<span class="sd">                speed &gt;= 1km/h and monotonically decreasing</span>
<span class="sd">    :type PHASE_DECELERATION: integer</span>

<span class="sd">    :param PHASE_DECELERATION_TO_STANDSTILL:</span>
<span class="sd">        DECELERATION phase preceding a STANDSTILL phase</span>
<span class="sd">    :type PHASE_DECELERATION_TO_STANDSTILL: integer</span>

<span class="sd">    :param TraceTimesCount:</span>
<span class="sd">        The length of trace times re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimesCount: integer</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: array</span>

<span class="sd">    :param SuppressGear0DuringDownshifts:</span>
<span class="sd">        Sub-Annex 2 (4f).If a gear is used for only 1 second during a deceleration phase</span>
<span class="sd">        it shall be replaced by gear 0 with clutch disengaged, in order to avoid too high</span>
<span class="sd">        engine speeds. But if this is not an issue, the manufacturer may allow to use the</span>
<span class="sd">        lower gear of the following second directly instead of gear 0 for downshifts of</span>
<span class="sd">        up to 3 steps.</span>
<span class="sd">    :type SuppressGear0DuringDownshifts: boolean</span>

<span class="sd">    :param ClutchDisengaged:</span>
<span class="sd">        The clutch disengaged by each second.</span>
<span class="sd">    :type ClutchDisengaged: boolean array</span>

<span class="sd">    :param InitialRequiredEngineSpeeds:</span>
<span class="sd">        The initial engine speeds required for each gear i from 1 to ng and</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">    :type InitialRequiredEngineSpeeds: array</span>

<span class="sd">    :param IdlingEngineSpeed:</span>
<span class="sd">        Annex 2 (2c) n_idle. The idling speed.</span>
<span class="sd">    :type IdlingEngineSpeed: float</span>

<span class="sd">    :param Phases:</span>
<span class="sd">        The list of phases that are used during whole cycle</span>
<span class="sd">    :type Phases: array</span>

<span class="sd">    :param InStandStill:</span>
<span class="sd">        Contains the points that are in standstill phase as a True</span>
<span class="sd">    :type InStandStill: boolean array</span>

<span class="sd">    :param InDecelerationToStandstill:</span>
<span class="sd">        The array that contains the seconds from deceleration to standstill as a True</span>
<span class="sd">    :type InDecelerationToStandstill: boolean array</span>

<span class="sd">    :param InDeceleration:</span>
<span class="sd">        Contains the points that are in deceleration phase as a True</span>
<span class="sd">    :type InDeceleration: boolean array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGearsFinal (:py:class:`numpy.array`):</span>
<span class="sd">            The initial gears after apply corrections calculated by each second.</span>
<span class="sd">        - CorrectionsCells (:py:class:`numpy.array`):</span>
<span class="sd">            Array of gear correction strings for debugging. This contains a historic</span>
<span class="sd">            transformation of each gear during all execution and the transformation</span>
<span class="sd">            applied.</span>
<span class="sd">        - ClutchDisengagedByGearFinal (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The clutch disengaged by each gear and each second after apply corrections.</span>
<span class="sd">        - ClutchUndefinedByGearFinal (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The clutch undefined by each gear and each second after apply corrections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

    <span class="n">CorrectionsCells</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">))]</span>
    <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
        <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span>
    <span class="p">)</span>

    <span class="n">corr_4d_applied_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">correction</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">Corr4bToBeDoneAfterCorr4a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">))</span>
        <span class="n">Corr4bToBeDoneAfterCorr4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">))</span>

        <span class="p">(</span>
            <span class="n">InitialGears</span><span class="p">,</span>
            <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span>
            <span class="n">Corr4bToBeDoneAfterCorr4d</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">applyCorrection4b</span><span class="p">(</span>
            <span class="n">InitialGears</span><span class="p">,</span>
            <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span>
            <span class="n">Corr4bToBeDoneAfterCorr4d</span><span class="p">,</span>
            <span class="n">PhaseValues</span><span class="p">,</span>
            <span class="n">PhaseStarts</span><span class="p">,</span>
            <span class="n">PhaseEnds</span><span class="p">,</span>
            <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">,</span>
            <span class="n">PHASE_ACCELERATION</span><span class="p">,</span>
            <span class="n">NoOfGearsFinal</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
            <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="s2">&quot;4b&quot;</span><span class="p">,</span> <span class="n">correction</span>
        <span class="p">)</span>

        <span class="n">InitialGears</span> <span class="o">=</span> <span class="n">applyCorrection4a</span><span class="p">(</span>
            <span class="n">InitialGears</span><span class="p">,</span>
            <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span>
            <span class="n">PossibleGears</span><span class="p">,</span>
            <span class="n">InAcceleration</span><span class="p">,</span>
            <span class="n">InConstantSpeed</span><span class="p">,</span>
            <span class="n">InAccelerationAnyDuration</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
            <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="s2">&quot;4a&quot;</span><span class="p">,</span> <span class="n">correction</span>
        <span class="p">)</span>

        <span class="c1"># Do an extra delayed gear correction &quot;4s&quot; ( s : short downshift )</span>
        <span class="c1"># which was determined during gear correction 4b</span>
        <span class="c1"># but shall be done after gear correction 4a.</span>
        <span class="c1"># This delayed correction must be suppressed at positions</span>
        <span class="c1"># where there is no such short downshift anymore</span>
        <span class="c1"># (and at positions where correction 4c will extend such short downshifts)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">enabled</span> <span class="o">=</span> <span class="n">_next_n_gears_are_higher</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">enabled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">igear</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]):</span>
            <span class="n">ClutchDisengagedByGear</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">igear</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchUndefinedByGear</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">igear</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
            <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="s2">&quot;4s&quot;</span><span class="p">,</span> <span class="n">correction</span>
        <span class="p">)</span>

        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># Regulation Annex 2, 4.(c) preface</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># The modification check described in paragraph 4.(c) of this annex</span>
        <span class="c1"># shall be applied to the complete cycle trace twice</span>
        <span class="c1"># prior to the application of paragraphs 4.(d) to 4.(f) of this annex.</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="k">for</span> <span class="n">correction_4c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">InitialGears</span> <span class="o">=</span> <span class="n">applyCorrection4c</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="n">PossibleGears</span><span class="p">)</span>
            <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
                <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="s2">&quot;4c&quot;</span><span class="p">,</span> <span class="n">correction</span>
            <span class="p">)</span>

        <span class="n">InitialGears</span> <span class="o">=</span> <span class="n">applyCorrection4d</span><span class="p">(</span>
            <span class="n">InitialGears</span><span class="p">,</span>
            <span class="n">PhaseStarts</span><span class="p">,</span>
            <span class="n">PhaseEnds</span><span class="p">,</span>
            <span class="n">PhaseValues</span><span class="p">,</span>
            <span class="n">PHASE_DECELERATION</span><span class="p">,</span>
            <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">,</span>
            <span class="n">corr_4d_applied_before</span><span class="p">,</span>
            <span class="n">TraceTimesCount</span><span class="p">,</span>
            <span class="n">NoOfGearsFinal</span><span class="p">,</span>
            <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
            <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="s2">&quot;4d&quot;</span><span class="p">,</span> <span class="n">correction</span>
        <span class="p">)</span>

        <span class="c1"># Do an extra delayed gear correction &quot;4t&quot; ( t : two step downshift )</span>
        <span class="c1"># which was determined during gear correction 4b</span>
        <span class="c1"># but shall be done after gear correction 4d (according Heinz Steven).</span>
        <span class="c1"># This delayed correction must be suppressed at positions</span>
        <span class="c1"># where there is no downshift by more than one gear anymore.</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">Corr4bToBeDoneAfterCorr4d</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">SuppressGear0DuringDownshifts</span><span class="p">:</span>
            <span class="n">nextCorr4bToBeDoneAfterCorr4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nextCorr4bToBeDoneAfterCorr4d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
            <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="s2">&quot;4t&quot;</span><span class="p">,</span> <span class="n">correction</span>
        <span class="p">)</span>

        <span class="c1"># But also such delayed gear corrections &quot;4t&quot; must be undone</span>
        <span class="c1"># when an even later 2nd gear correction 4d</span>
        <span class="c1"># reduces such downshifts to downshift by only one gear.</span>
        <span class="n">prevInitialGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nextInitialGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialGears</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prevInitialGears</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">nextInitialGears</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nextInitialGears</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">InitialGears</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">InitialGears</span><span class="p">,</span> <span class="n">ClutchDisengaged</span> <span class="o">=</span> <span class="n">applyCorrection4e</span><span class="p">(</span>
            <span class="n">InitialGears</span><span class="p">,</span>
            <span class="n">PhaseStarts</span><span class="p">,</span>
            <span class="n">PhaseEnds</span><span class="p">,</span>
            <span class="n">PhaseValues</span><span class="p">,</span>
            <span class="n">ClutchDisengaged</span><span class="p">,</span>
            <span class="n">InitialRequiredEngineSpeeds</span><span class="p">,</span>
            <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
            <span class="n">PHASE_DECELERATION</span><span class="p">,</span>
            <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">,</span>
            <span class="n">Phases</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
            <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="s2">&quot;4e&quot;</span><span class="p">,</span> <span class="n">correction</span>
        <span class="p">)</span>

        <span class="n">InitialGears</span><span class="p">,</span> <span class="n">ClutchDisengaged</span> <span class="o">=</span> <span class="n">applyCorrection4f</span><span class="p">(</span>
            <span class="n">InitialGears</span><span class="p">,</span>
            <span class="n">ClutchDisengaged</span><span class="p">,</span>
            <span class="n">SuppressGear0DuringDownshifts</span><span class="p">,</span>
            <span class="n">PossibleGears</span><span class="p">,</span>
            <span class="n">InStandStill</span><span class="p">,</span>
            <span class="n">InDecelerationToStandstill</span><span class="p">,</span>
            <span class="n">InDeceleration</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">appendCorrectionCells</span><span class="p">(</span>
            <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="s2">&quot;4f&quot;</span><span class="p">,</span> <span class="n">correction</span>
        <span class="p">)</span>

    <span class="n">InitialGearsFinal</span> <span class="o">=</span> <span class="n">InitialGears</span>
    <span class="n">ClutchDisengagedByGearFinal</span> <span class="o">=</span> <span class="n">ClutchDisengagedByGear</span>
    <span class="n">ClutchUndefinedByGearFinal</span> <span class="o">=</span> <span class="n">ClutchUndefinedByGear</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">InitialGearsFinal</span><span class="p">,</span>
        <span class="n">CorrectionsCells</span><span class="p">,</span>
        <span class="n">ClutchDisengagedByGearFinal</span><span class="p">,</span>
        <span class="n">ClutchUndefinedByGearFinal</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AverageGear&quot;</span><span class="p">,</span> <span class="s2">&quot;PhaseSum&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">calculate_average_gear</span><span class="p">(</span><span class="n">Phases</span><span class="p">,</span> <span class="n">PHASE_STANDSTILL</span><span class="p">,</span> <span class="n">InitialGearsFinal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Average Gear</span>

<span class="sd">    :param Phases:</span>
<span class="sd">        The list of phases that are used during whole cycle</span>
<span class="sd">    :type Phases: array</span>

<span class="sd">    :param PHASE_STANDSTILL:</span>
<span class="sd">        Time period with required vehicle speed &lt; 1km/h</span>
<span class="sd">    :type PHASE_STANDSTILL: integer</span>

<span class="sd">    :param InitialGearsFinal:</span>
<span class="sd">        The initial gears after apply corrections calculated by each second.</span>
<span class="sd">    :type InitialGearsFinal: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGearsFinal (:py:class:`float`):</span>
<span class="sd">            Annex 2 (5) average gear</span>
<span class="sd">            In order to enable the assessment of the correctness of the calculation,</span>
<span class="sd">            the average gear for v &gt;= 1 km/h, rounded to four places of decimal,</span>
<span class="sd">            shall be calculated and recorded.</span>
<span class="sd">        - PhaseSum (:py:class:`boolean numpy.array`):</span>
<span class="sd">            Annex 2 (5) average gear</span>
<span class="sd">            In order to enable the assessment of the correctness of the calculation,</span>
<span class="sd">            the average gear for v &gt;= 1 km/h, rounded to four places of decimal,</span>
<span class="sd">            shall be calculated and recorded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PhaseSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Phases</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">PhaseSum</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">!=</span> <span class="n">PHASE_STANDSTILL</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">InitialGearsFinal</span><span class="p">))</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">AverageGear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">InitialGearsFinal</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseSum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PhaseSum</span><span class="p">),</span> <span class="mi">4</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">AverageGear</span><span class="p">,</span> <span class="n">PhaseSum</span>


<div class="viewcode-block" id="calculate_average_gear"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.calculate_average_gear">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ChecksumVxGear&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">calculate_average_gear</span><span class="p">(</span><span class="n">PhaseSum</span><span class="p">,</span> <span class="n">InitialGearsFinal</span><span class="p">,</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate average gear</span>

<span class="sd">    :param PhaseSum:</span>
<span class="sd">        The all phases that are different of standstill phase</span>
<span class="sd">    :type PhaseSum: boolean array</span>

<span class="sd">    :param InitialGearsFinal:</span>
<span class="sd">        The initial gears after apply corrections calculated by each second.</span>
<span class="sd">    :type InitialGearsFinal: array</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - ChecksumVxGear (:py:class:`float`):</span>
<span class="sd">            Checksum of v * gear for v &gt;= 1 km/h rounded to four places of decimal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ChecksumVxGear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">InitialGearsFinal</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseSum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="o">*</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseSum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ChecksumVxGear</span></div>


<div class="viewcode-block" id="interleave_clutch"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.interleave_clutch">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span>
    <span class="n">dsp</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;InitialGearsFinalAfterClutch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ClutchDisengagedFinal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ClutchUndefinedFinal&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">interleave_clutch</span><span class="p">(</span>
    <span class="n">TraceTimesCount</span><span class="p">,</span>
    <span class="n">InitialGearsFinal</span><span class="p">,</span>
    <span class="n">ClutchDisengagedByGearFinal</span><span class="p">,</span>
    <span class="n">ClutchDisengaged</span><span class="p">,</span>
    <span class="n">ClutchUndefinedByGearFinal</span><span class="p">,</span>
    <span class="n">ClutchUndefined</span><span class="p">,</span>
    <span class="n">AutomaticClutchOperation</span><span class="p">,</span>
    <span class="n">InDeceleration</span><span class="p">,</span>
    <span class="n">AdvancedClutchDisengage</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interleave the clutch Sub-Annex 2 (1.5)</span>

<span class="sd">    .. note::</span>
<span class="sd">    The prescriptions for the clutch operation shall not be applied if the clutch</span>
<span class="sd">    is operated automatically without the need of an engagement or disengagement</span>
<span class="sd">    of the driver.</span>

<span class="sd">    :param TraceTimesCount:</span>
<span class="sd">        The length of trace times re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimesCount: integer</span>

<span class="sd">    :param InitialGearsFinal:</span>
<span class="sd">        The initial gears after apply corrections calculated by each second.</span>
<span class="sd">    :type InitialGearsFinal: array</span>

<span class="sd">    :param ClutchDisengagedByGearFinal:</span>
<span class="sd">        The clutch disengaged by each gear and each second after apply corrections.</span>
<span class="sd">    :type ClutchDisengagedByGearFinal: boolean array</span>

<span class="sd">    :param ClutchDisengaged:</span>
<span class="sd">        The clutch disengaged by each second.</span>
<span class="sd">    :type ClutchDisengaged: boolean array</span>

<span class="sd">    :param ClutchUndefinedByGearFinal:</span>
<span class="sd">        The clutch undefined by each gear and each second after apply corrections.</span>
<span class="sd">    :type ClutchUndefinedByGearFinal: boolean array</span>

<span class="sd">    :param ClutchUndefined:</span>
<span class="sd">        The clutch undefined by each second.</span>
<span class="sd">    :type ClutchUndefined: boolean array</span>

<span class="sd">    :param AutomaticClutchOperation:</span>
<span class="sd">        Sub-Annex 2 (1.5)</span>
<span class="sd">        The prescriptions for the clutch operation shall not be applied if the clutch</span>
<span class="sd">        is operated automatically without the need of an engagement or disengagement</span>
<span class="sd">        of the driver.</span>
<span class="sd">    :type AutomaticClutchOperation: boolean</span>

<span class="sd">    :param InDeceleration:</span>
<span class="sd">        Contains the points that are in deceleration phase as a True</span>
<span class="sd">    :type InDeceleration: boolean array</span>

<span class="sd">    :param AdvancedClutchDisengage:</span>
<span class="sd">        The seconds in which the advanced clutch disengage</span>
<span class="sd">    :type AdvancedClutchDisengage: list</span>

<span class="sd">    :return InitialGearsFinalAfterClutch:</span>
<span class="sd">        The initial gears after apply corrections calculated by each second and the</span>
<span class="sd">        interleave clutch.</span>
<span class="sd">    :rtype InitialGearsFinalAfterClutch: array</span>

<span class="sd">    :return ClutchDisengagedFinal:</span>
<span class="sd">        The clutch disengaged by each second after apply the interleave clutch</span>
<span class="sd">    :rtype ClutchDisengagedFinal: boolean array</span>

<span class="sd">    :return ClutchUndefinedFinal:</span>
<span class="sd">        The clutch undefined by each second after apply the interleave clutch</span>
<span class="sd">    :rtype ClutchUndefinedFinal: boolean array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This is a test parameter that can be included in the inputs in the future</span>
    <span class="n">DoNotMergeClutchIntoGearsOutput</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">TraceTimesCount</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">InitialGearsFinal</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ClutchDisengagedByGearFinal</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">InitialGearsFinal</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ClutchUndefinedByGearFinal</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">InitialGearsFinal</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ClutchUndefined</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">AutomaticClutchOperation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">DoNotMergeClutchIntoGearsOutput</span><span class="p">:</span>
        <span class="n">InitialGearsFinal</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDeceleration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ClutchDisengaged</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">AdvancedClutchDisengage</span><span class="p">:</span>
            <span class="n">InitialGearsFinal</span><span class="p">[</span><span class="n">ad</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">InitialGearsFinalAfterClutch</span> <span class="o">=</span> <span class="n">InitialGearsFinal</span>
    <span class="n">ClutchDisengagedFinal</span> <span class="o">=</span> <span class="n">ClutchDisengaged</span>
    <span class="n">ClutchUndefinedFinal</span> <span class="o">=</span> <span class="n">ClutchUndefined</span>

    <span class="k">return</span> <span class="n">InitialGearsFinalAfterClutch</span><span class="p">,</span> <span class="n">ClutchDisengagedFinal</span><span class="p">,</span> <span class="n">ClutchUndefinedFinal</span></div>


<div class="viewcode-block" id="remove_duplicate_gears"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.remove_duplicate_gears">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ClutchHST&quot;</span><span class="p">,</span> <span class="s2">&quot;GearSequenceStarts&quot;</span><span class="p">,</span> <span class="s2">&quot;GearNames&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">remove_duplicate_gears</span><span class="p">(</span>
    <span class="n">InitialGearsFinalAfterClutch</span><span class="p">,</span> <span class="n">ClutchUndefinedFinal</span><span class="p">,</span> <span class="n">ClutchDisengagedFinal</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove duplicate gears</span>

<span class="sd">    :param InitialGearsFinalAfterClutch:</span>
<span class="sd">        The initial gears after apply corrections calculated by each second and the</span>
<span class="sd">        interleave clutch.</span>
<span class="sd">    :type InitialGearsFinalAfterClutch: array</span>

<span class="sd">    :param ClutchUndefinedFinal:</span>
<span class="sd">        The clutch undefined by each second after apply the interleave clutch</span>
<span class="sd">    :type ClutchUndefinedFinal: boolean array</span>

<span class="sd">    :param ClutchDisengagedFinal:</span>
<span class="sd">        The clutch disengaged by each second after apply the interleave clutch</span>
<span class="sd">    :type ClutchDisengagedFinal: boolean array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - ClutchHST (:py:class:`float`):</span>
<span class="sd">            Array of clutch state names as used by the Heinz Steven Tool (HST).</span>
<span class="sd">        - GearSequenceStarts (:py:class:`numpy.array`):</span>
<span class="sd">            Array that contains the position of the gear sequence start for the different</span>
<span class="sd">            gears.</span>
<span class="sd">        - GearSequenceStarts (:py:class:`numpy.array`):</span>
<span class="sd">            The name of gear to used by each gear sequence starts.</span>

<span class="sd">    .. note:: A clutch disengagement and a gear change cannot be indicated at the same time</span>
<span class="sd">        and the clutch disengagement will therefore be indicated one second earlier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
    <span class="kn">import</span> <span class="nn">regex</span> <span class="k">as</span> <span class="nn">re</span>

    <span class="n">GearSequenceStarts</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">InitialGearsFinalAfterClutch</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">InitialGearsFinalAfterClutch</span><span class="p">[</span><span class="mi">1</span><span class="p">:])),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">InitialGearsFinalAfterClutch</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">GearSequenceStarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">GearSequenceStarts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">GearNames</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;MANUAL-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ig</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ig</span> <span class="ow">in</span> <span class="n">InitialGearsFinalAfterClutch</span><span class="p">[</span><span class="n">GearSequenceStarts</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">GearNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;MANUAL-0&quot;</span><span class="p">,</span> <span class="s2">&quot;MANUAL-NEUTRAL&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">GearNames</span><span class="p">]</span>
    <span class="n">GearNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;MANUAL--1&quot;</span><span class="p">,</span> <span class="s2">&quot;MANUAL-CLUTCH&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">GearNames</span><span class="p">]</span>

    <span class="c1"># generate clutch state strings as done by Heinz Steven Tool (HST)</span>
    <span class="n">ClutchHST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ClutchDisengagedFinal</span><span class="p">),</span> <span class="s2">&quot;                              &quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ClutchDisengagedFinal</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">ClutchUndefinedFinal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ClutchHST</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;undefined&quot;</span>
        <span class="k">elif</span> <span class="n">ClutchDisengagedFinal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ClutchHST</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;disengaged&quot;</span>
        <span class="k">elif</span> <span class="n">InitialGearsFinalAfterClutch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ClutchHST</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;engaged; gear lever in neutral&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ClutchHST</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;engaged&quot;</span>

    <span class="k">return</span> <span class="n">ClutchHST</span><span class="p">,</span> <span class="n">GearSequenceStarts</span><span class="p">,</span> <span class="n">GearNames</span></div>


<div class="viewcode-block" id="reduce_vehicle_speed_if_not_enough_power"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.reduce_vehicle_speed_if_not_enough_power">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AvailablePowersFinal&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">reduce_vehicle_speed_if_not_enough_power</span><span class="p">(</span>
    <span class="n">DefinedPowerCurveAdditionalSafetyMargins</span><span class="p">,</span>
    <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
    <span class="n">PowerCurvePowers</span><span class="p">,</span>
    <span class="n">SafetyMargin</span><span class="p">,</span>
    <span class="n">PowerCurveASM</span><span class="p">,</span>
    <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
    <span class="n">RequiredEngineSpeeds</span><span class="p">,</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
    <span class="n">f0</span><span class="p">,</span>
    <span class="n">f1</span><span class="p">,</span>
    <span class="n">f2</span><span class="p">,</span>
    <span class="n">VehicleTestMass</span><span class="p">,</span>
    <span class="n">requiredPowersF</span><span class="p">,</span>
    <span class="n">ClutchDisengagedFinal</span><span class="p">,</span>
    <span class="n">ClutchUndefinedFinal</span><span class="p">,</span>
    <span class="n">InitialGearsFinalAfterClutch</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">AvailablePowers</span><span class="p">,</span>
    <span class="n">NdvRatios</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduce vehicle speed if not enough power is available</span>

<span class="sd">    :param DefinedPowerCurveAdditionalSafetyMargins:</span>
<span class="sd">        Boolean that define if the additional save margins are present</span>
<span class="sd">    :type DefinedPowerCurveAdditionalSafetyMargins: boolean</span>

<span class="sd">    :param PowerCurveEngineSpeeds:</span>
<span class="sd">        Contains the power curve engine speeds</span>
<span class="sd">    :type PowerCurveEngineSpeeds: array</span>

<span class="sd">    :param PowerCurvePowers:</span>
<span class="sd">        Contains the power curve powers</span>
<span class="sd">    :type PowerCurvePowers: array</span>

<span class="sd">    :param SafetyMargin:</span>
<span class="sd">        Annex 2 (3.4) SM</span>
<span class="sd">        The safety margin is accounting for the difference between the</span>
<span class="sd">        stationary full load condition power curve and the power available</span>
<span class="sd">        during transition conditions.</span>
<span class="sd">        SM is set to 10 per cent.</span>
<span class="sd">    :type SafetyMargin: float</span>

<span class="sd">    :param PowerCurveASM:</span>
<span class="sd">        Contains the power curve additional save margin</span>
<span class="sd">    :type PowerCurveASM: array</span>

<span class="sd">    :param IdlingEngineSpeed:</span>
<span class="sd">        Annex 2 (2c) n_idle. The idling speed.</span>
<span class="sd">    :type IdlingEngineSpeed: float</span>

<span class="sd">    :param RequiredEngineSpeeds:</span>
<span class="sd">        Annex 2 (3.2) n_i,j</span>
<span class="sd">        The engine speeds required</span>
<span class="sd">        for each gear i from 1 to ng and</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">        Note that this are the uncorrected values n_i,j</span>
<span class="sd">        ie without the increments required by Annex 2 (3.3)</span>
<span class="sd">    :type RequiredEngineSpeeds: array</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: array</span>

<span class="sd">    :param f0:</span>
<span class="sd">        The constant road load coefficient,</span>
<span class="sd">        i.e. independent of velocity, caused by internal frictional resistances.</span>
<span class="sd">    :type f0: float</span>

<span class="sd">    :param f1:</span>
<span class="sd">        The linear road load coefficient,</span>
<span class="sd">        i.e. proportional to velocity, caused by tyres rolling resistances.</span>
<span class="sd">    :type f1: float</span>

<span class="sd">    :param f2:</span>
<span class="sd">        The quadratic road load coefficient,</span>
<span class="sd">        i.e. quadratical to velocity, caused by aerodynamic resistances.</span>
<span class="sd">    :type f2: float</span>

<span class="sd">    :param VehicleTestMass:</span>
<span class="sd">        The test mass of the vehicle.</span>
<span class="sd">    :type VehicleTestMass: float</span>

<span class="sd">    :param requiredPowersF:</span>
<span class="sd">        Annex 2 (3.1) P_required,j</span>
<span class="sd">        The power required to overcome driving resistance and to accelerate</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">    :type requiredPowersF: array</span>

<span class="sd">    :param ClutchDisengagedFinal:</span>
<span class="sd">        The clutch disengaged by each second after apply the interleave clutch</span>
<span class="sd">    :type ClutchDisengagedFinal: boolean array</span>

<span class="sd">    :param ClutchUndefinedFinal:</span>
<span class="sd">        The clutch undefined by each second after apply the interleave clutch</span>
<span class="sd">    :type ClutchUndefinedFinal: boolean array</span>

<span class="sd">    :param InitialGearsFinalAfterClutch:</span>
<span class="sd">        The initial gears after apply corrections calculated by each second and the</span>
<span class="sd">        interleave clutch.</span>
<span class="sd">    :type InitialGearsFinalAfterClutch: array</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: integer</span>

<span class="sd">    :param AvailablePowers:</span>
<span class="sd">        Annex 2 (3.4) P_available_i,j</span>
<span class="sd">        The power available for each gear i from 1 to ng and for each second j</span>
<span class="sd">        of the cycle trace.</span>
<span class="sd">        Note that this power values are determined from uncorrected values n_i,j</span>
<span class="sd">        i.e. without the engine speed increments required by Annex 2 (3.3)</span>
<span class="sd">    :type AvailablePowers: array</span>

<span class="sd">    :param NdvRatios:</span>
<span class="sd">        The ratio obtained by dividing the engine speed n by the vehicle speed v</span>
<span class="sd">        for each gear i form 1 to ng after apply the exclusion of first gear if</span>
<span class="sd">        is necessary.</span>
<span class="sd">    :type NdvRatios: array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - AvailablePowersFinal (:py:class:`numpy.array`):</span>
<span class="sd">            Annex 2 (3.4) P_available_i,j</span>
<span class="sd">            The power available for each gear i from 1 to ng and for each second j</span>
<span class="sd">            of the cycle trace, after check vehicle speed.</span>
<span class="sd">            Note that this power values are determined from uncorrected values n_i,j</span>
<span class="sd">            i.e. without the engine speed increments required by Annex 2 (3.3)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

    <span class="c1"># This is a test parameter that can be included in the inputs in the future</span>
    <span class="n">LimitVehicleSpeedByAvailablePower</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">LimitVehicleSpeedByAvailablePower</span><span class="p">:</span>
        <span class="c1"># if the clutch is &quot;undefined&quot; then assume that</span>
        <span class="c1"># the available power is determined from the engine speed</span>
        <span class="c1"># also used for transitions from first to second gear</span>
        <span class="c1">#</span>
        <span class="c1">#   Annex 2</span>
        <span class="c1">#</span>
        <span class="c1">#     2.(k)</span>
        <span class="c1">#       (2) For n_gear = 2,</span>
        <span class="c1">#         (i) for transitions from first to second gear:</span>
        <span class="c1">#           n_min_drive = 1.15 × n_idle,</span>
        <span class="c1">#</span>
        <span class="c1">#     3.3. Selection of possible gears with respect to engine speed</span>
        <span class="c1">#       If   a_j &gt;= 0</span>
        <span class="c1">#       and  n_i,j &lt;  max( 1.15 × n_idle, min. engine speed of the P_wot(n) curve )</span>
        <span class="c1">#       then n_i,j := max( 1.15 × n_idle, min. engine speed of the P_wot(n) curve )</span>
        <span class="c1">#       and the clutch shall be set to &quot;undefined&quot;.</span>
        <span class="c1">#</span>
        <span class="c1"># if the clutch is &quot;disengaged&quot; then assume that</span>
        <span class="c1"># the available power is determined from the idling engine speed n_idle</span>
        <span class="c1"># but if n_idle &lt; min. engine speed of the P_wot(n) curve</span>
        <span class="c1"># then no check for the available power will be done</span>
        <span class="c1">#</span>
        <span class="c1">#   Annex 2</span>
        <span class="c1">#</span>
        <span class="c1">#     3.3. Selection of possible gears with respect to engine speed</span>
        <span class="c1">#       If   a_j &lt; 0</span>
        <span class="c1">#       and  n_i,j &lt;= n_idle</span>
        <span class="c1">#       then n_i,j := n_idle</span>
        <span class="c1">#       and the clutch shall be set to &quot;disengaged&quot;.</span>
        <span class="c1">#</span>
        <span class="c1"># note that the available power defined by the P_wot(n) curve</span>
        <span class="k">if</span> <span class="n">DefinedPowerCurveAdditionalSafetyMargins</span><span class="p">:</span>

            <span class="n">interpval</span> <span class="o">=</span> <span class="n">PowerCurvePowers</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">SafetyMargin</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">PowerCurveASM</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="p">)</span>

            <span class="n">AvailablePowerClutchDisengaged</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
                <span class="n">interpval</span><span class="p">,</span>
                <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="p">)(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
                        <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">AvailablePowerClutchUndefined</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
                <span class="n">interpval</span><span class="p">,</span>
                <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="p">)(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="mf">1.15</span> <span class="o">*</span> <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
                        <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">CheckAvailablePowerClutchDisengaged</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">IdlingEngineSpeed</span> <span class="o">&gt;=</span> <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">PowerForRestistance</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f0</span> <span class="o">*</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">f1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">f2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span>

            <span class="n">Acceleration</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="mf">3.6</span>
            <span class="n">PowerForAcceleration</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Acceleration</span> <span class="o">*</span> <span class="mf">1.03</span> <span class="o">*</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">VehicleTestMass</span> <span class="o">/</span> <span class="mi">3600</span>
            <span class="p">)</span>
            <span class="n">requiredPowersF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PowerForRestistance</span> <span class="o">+</span> <span class="n">PowerForAcceleration</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">InitialGearsFinalAfterClutch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ClutchDisengagedFinal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">g</span> <span class="o">&lt;=</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ClutchDisengagedFinal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ClutchUndefinedFinal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">CheckAvailablePower</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">AvailablePower</span> <span class="o">=</span> <span class="n">AvailablePowerClutchUndefined</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">CheckAvailablePower</span> <span class="o">=</span> <span class="n">CheckAvailablePowerClutchDisengaged</span>
                        <span class="n">AvailablePower</span> <span class="o">=</span> <span class="n">AvailablePowerClutchDisengaged</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">CheckAvailablePower</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">AvailablePower</span> <span class="o">=</span> <span class="n">AvailablePowers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">CheckAvailablePower</span>
                    <span class="ow">and</span> <span class="n">requiredPowersF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">AvailablePower</span>
                    <span class="ow">and</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">ClutchDisengagedFinal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="ow">or</span> <span class="n">RequiredEngineSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">&gt;</span> <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">requiredPowersF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">AvailablePower</span>
                    <span class="n">PowerForAcceleration</span> <span class="o">=</span> <span class="n">AvailablePower</span> <span class="o">-</span> <span class="n">PowerForRestistance</span>
                    <span class="n">Acceleration</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">PowerForAcceleration</span>
                        <span class="o">/</span> <span class="p">(</span><span class="mf">1.03</span> <span class="o">*</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">VehicleTestMass</span><span class="p">)</span>
                        <span class="o">*</span> <span class="mi">3600</span>
                    <span class="p">)</span>
                    <span class="n">NextVehicleSpeed</span> <span class="o">=</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Acceleration</span> <span class="o">*</span> <span class="mf">3.6</span>
                    <span class="k">if</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">NextVehicleSpeed</span><span class="p">:</span>
                        <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NextVehicleSpeed</span>
                        <span class="n">RequiredEngineSpeeds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">NextVehicleSpeed</span> <span class="o">*</span> <span class="n">NdvRatios</span>

                    <span class="c1"># determine available powers for next trace second with reduced vehicle speed</span>
                    <span class="k">if</span> <span class="n">DefinedPowerCurveAdditionalSafetyMargins</span><span class="p">:</span>
                        <span class="n">interpval</span> <span class="o">=</span> <span class="n">PowerCurvePowers</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">SafetyMargin</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">PowerCurveASM</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                                <span class="n">AvailablePowers</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                                    <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
                                    <span class="n">interpval</span><span class="p">,</span>
                                    <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                <span class="p">)(</span>
                                    <span class="nb">max</span><span class="p">(</span>
                                        <span class="n">RequiredEngineSpeeds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span>
                                        <span class="n">PowerCurveEngineSpeeds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">AvailablePowers</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                                    <span class="n">PowerCurveEngineSpeeds</span><span class="p">,</span>
                                    <span class="n">interpval</span><span class="p">,</span>
                                    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                                    <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
                                <span class="p">)(</span><span class="n">RequiredEngineSpeeds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>

    <span class="n">AvailablePowersFinal</span> <span class="o">=</span> <span class="n">AvailablePowers</span>

    <span class="k">return</span> <span class="n">AvailablePowersFinal</span></div>


<div class="viewcode-block" id="generate_gears"><a class="viewcode-back" href="../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.html#gearshift.core.model.calculateShiftpointsNdvFullPC.generate_gears">[docs]</a><span class="nd">@sh</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;shift_points&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">generate_gears</span><span class="p">(</span>
    <span class="n">TraceTimes</span><span class="p">,</span>
    <span class="n">GearSequenceStarts</span><span class="p">,</span>
    <span class="n">GearNames</span><span class="p">,</span>
    <span class="n">AverageGear</span><span class="p">,</span>
    <span class="n">Max95EngineSpeedFinal</span><span class="p">,</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
    <span class="n">requiredPowersF</span><span class="p">,</span>
    <span class="n">RequiredEngineSpeeds</span><span class="p">,</span>
    <span class="n">PossibleGearsByEngineSpeed</span><span class="p">,</span>
    <span class="n">AvailablePowersFinal</span><span class="p">,</span>
    <span class="n">InitialRequiredEngineSpeeds</span><span class="p">,</span>
    <span class="n">InitialAvailablePowers</span><span class="p">,</span>
    <span class="n">FullPowerCurve</span><span class="p">,</span>
    <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span><span class="p">,</span>
    <span class="n">EngineSpeedAtGearAtMaxVehicleSpeed</span><span class="p">,</span>
    <span class="n">MaxEngineSpeed</span><span class="p">,</span>
    <span class="n">MaxVehicleSpeedFinal</span><span class="p">,</span>
    <span class="n">GearAtMaxVehicleSpeedFinal</span><span class="p">,</span>
    <span class="n">MinDrive1st</span><span class="p">,</span>
    <span class="n">MinDrive1stTo2nd</span><span class="p">,</span>
    <span class="n">MinDrive2ndDecel</span><span class="p">,</span>
    <span class="n">MinDrive2nd</span><span class="p">,</span>
    <span class="n">MinDriveGreater2nd</span><span class="p">,</span>
    <span class="n">InitialGearsFinalAfterClutch</span><span class="p">,</span>
    <span class="n">ClutchDisengagedFinal</span><span class="p">,</span>
    <span class="n">ClutchUndefinedFinal</span><span class="p">,</span>
    <span class="n">ClutchHST</span><span class="p">,</span>
    <span class="n">CorrectionsCells</span><span class="p">,</span>
    <span class="n">ChecksumVxGear</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign outputs in the final dictionary</span>

<span class="sd">    :param TraceTimes:</span>
<span class="sd">        Times for each vehicle speed required re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimes: array</span>

<span class="sd">    :param GearSequenceStarts:</span>
<span class="sd">        Array that contains the position of the gear sequence start for the different</span>
<span class="sd">        gears.</span>
<span class="sd">        .. note::</span>
<span class="sd">        A clutch disengagement and a gear change cannot be indicated at the same time</span>
<span class="sd">        and the clutch disengagement will therefore be indicated one second earlier.</span>
<span class="sd">    :type GearSequenceStarts: array</span>

<span class="sd">    :param GearNames:</span>
<span class="sd">        The name of gear to used by each gear sequence starts.</span>
<span class="sd">    :type GearNames: array</span>

<span class="sd">    :param AverageGear:</span>
<span class="sd">        Annex 2 (5) average gear</span>
<span class="sd">        In order to enable the assessment of the correctness of the calculation,</span>
<span class="sd">        the average gear for v &gt;= 1 km/h, rounded to four places of decimal,</span>
<span class="sd">        shall be calculated and recorded.</span>
<span class="sd">    :type AverageGear: float</span>

<span class="sd">    :param Max95EngineSpeedFinal:</span>
<span class="sd">         Annex 2 (2g) n_max1 = n_95_high adjusted</span>
<span class="sd">         If n_95_high cannot be determined because the engine speed is limited to</span>
<span class="sd">         a lower value n_lim for all gears and the corresponding full load power</span>
<span class="sd">         is higher than 95 per cent of rated power, n_95_high shall be set to n_lim.</span>
<span class="sd">    :type Max95EngineSpeedFinal: float</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: array</span>

<span class="sd">    :param requiredPowersF:</span>
<span class="sd">        Annex 2 (3.1) P_required,j</span>
<span class="sd">        The power required to overcome driving resistance and to accelerate</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">    :type requiredPowersF: array</span>

<span class="sd">    :param RequiredEngineSpeeds:</span>
<span class="sd">        Annex 2 (3.2) n_i,j</span>
<span class="sd">        The engine speeds required</span>
<span class="sd">        for each gear i from 1 to ng and</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">        Note that this are the uncorrected values n_i,j</span>
<span class="sd">        ie without the increments required by Annex 2 (3.3)</span>
<span class="sd">    :type RequiredEngineSpeeds: array</span>

<span class="sd">    :param PossibleGearsByEngineSpeed:</span>
<span class="sd">        The possible gear that can be used for each second.</span>
<span class="sd">    :type PossibleGearsByEngineSpeed: boolean array</span>

<span class="sd">    :param AvailablePowersFinal:</span>
<span class="sd">        Annex 2 (3.4) P_available_i,j</span>
<span class="sd">        The power available for each gear i from 1 to ng and for each second j</span>
<span class="sd">        of the cycle trace, after check vehicle speed.</span>
<span class="sd">        Note that this power values are determined from uncorrected values n_i,j</span>
<span class="sd">        i.e. without the engine speed increments required by Annex 2 (3.3)</span>
<span class="sd">    :type AvailablePowersFinal: array</span>

<span class="sd">    :param InitialRequiredEngineSpeeds:</span>
<span class="sd">        The initial engine speeds required for each gear i from 1 to ng and</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">    :type InitialRequiredEngineSpeeds: array</span>

<span class="sd">    :param InitialAvailablePowers:</span>
<span class="sd">        Annex 2 (3.4) P_available_i,j (initials)</span>
<span class="sd">        The power available for each gear i from 1 to ng and for each second j</span>
<span class="sd">        of the cycle trace.</span>
<span class="sd">        Note that this power values are determined from uncorrected values n_i,j</span>
<span class="sd">        i.e. without the engine speed increments required by Annex 2 (3.3)</span>
<span class="sd">    :type InitialAvailablePowers: array</span>

<span class="sd">    :param FullPowerCurve:</span>
<span class="sd">        Annex 2 (2h) and (3.4) n ==&gt; P_wot(n), ASM</span>
<span class="sd">        The full load power curve over the engine speed range.</span>
<span class="sd">    :type FullPowerCurve: array</span>

<span class="sd">    :param EngineSpeedAtGearAtMaxRequiredSpeed:</span>
<span class="sd">        The engine speed at gear maximum required speed</span>
<span class="sd">    :type EngineSpeedAtGearAtMaxRequiredSpeed: float</span>

<span class="sd">    :param EngineSpeedAtGearAtMaxVehicleSpeed:</span>
<span class="sd">        The engine speed at gear at maximum vehicle speed</span>
<span class="sd">    :type EngineSpeedAtGearAtMaxVehicleSpeed: float</span>

<span class="sd">    :param MaxEngineSpeed:</span>
<span class="sd">        The maximum engine speed</span>
<span class="sd">    :type MaxEngineSpeed: float</span>

<span class="sd">    :param MaxVehicleSpeedFinal:</span>
<span class="sd">        Annex 2 (2g, 2i) v_max,vehicle</span>
<span class="sd">        The maximum vehicle speed reachable</span>
<span class="sd">        using the gear in which the maximum vehicle speed can be reached.</span>
<span class="sd">    :type MaxVehicleSpeedFinal: float</span>

<span class="sd">    :param GearAtMaxVehicleSpeedFinal:</span>
<span class="sd">        Annex 2 (2i) ng_vmax</span>
<span class="sd">        The gear in which the maximum vehicle speed is reached.</span>
<span class="sd">    :type GearAtMaxVehicleSpeedFinal: integer</span>

<span class="sd">    :param MinDrive1st:</span>
<span class="sd">        Annex 2 (2k) n_min_drive = n_idle for n_gear:1</span>
<span class="sd">        The minimum engine speed when the vehicle is in motion.</span>
<span class="sd">        This is the maximum of calculated value and input parameter value.</span>
<span class="sd">    :type MinDrive1st: float</span>

<span class="sd">    :param MinDrive1stTo2nd:</span>
<span class="sd">        Annex 2 (2ka) n_min_drive = 1.15 x n_idle for n_gear:1-&gt;2</span>
<span class="sd">        The minimum engine speed for transitions from first to second gear.</span>
<span class="sd">        This is the maximum of calculated value and input parameter value.</span>
<span class="sd">    :type MinDrive1stTo2nd: float</span>

<span class="sd">    :param MinDrive2ndDecel:</span>
<span class="sd">        Annex 2 (2kb) n_min_drive = n_idle for n_gear:2</span>
<span class="sd">        The minimum engine speed for decelerations to standstill in second gear.</span>
<span class="sd">        This is the maximum of calculated value and input parameter value.</span>
<span class="sd">    :type MinDrive2ndDecel: float</span>

<span class="sd">    :param MinDrive2nd:</span>
<span class="sd">        Annex 2 (2kc) n_min_drive = 0.9 x n_idle for n_gear:2</span>
<span class="sd">        The minimum engine speed for all other driving conditions in second gear.</span>
<span class="sd">        This is the maximum of calculated value and input parameter value.</span>
<span class="sd">    :type MinDrive2nd: float</span>

<span class="sd">    :param MinDriveGreater2nd:</span>
<span class="sd">        Annex 2 (2k) n_min_drive = n_idle + 0.125 × ( n_rated - n_idle ) for n_gear:3..</span>
<span class="sd">        This value shall be referred to as n_min_drive_set.</span>
<span class="sd">        The minimum engine speed for all driving conditions in gears greater than 2.</span>
<span class="sd">        This is the maximum of calculated value and input parameter value.</span>
<span class="sd">    :type MinDriveGreater2nd: float</span>

<span class="sd">    :param InitialGearsFinalAfterClutch:</span>
<span class="sd">        The initial gears after apply corrections calculated by each second and the</span>
<span class="sd">        interleave clutch.</span>
<span class="sd">    :type InitialGearsFinalAfterClutch: array</span>

<span class="sd">    :param ClutchDisengagedFinal:</span>
<span class="sd">        The clutch disengaged by each second after apply the interleave clutch</span>
<span class="sd">    :type ClutchDisengagedFinal: boolean array</span>

<span class="sd">    :param ClutchUndefinedFinal:</span>
<span class="sd">        The clutch undefined by each second after apply the interleave clutch</span>
<span class="sd">    :type ClutchUndefinedFinal: boolean array</span>

<span class="sd">    :param ClutchHST:</span>
<span class="sd">        Array of clutch state names as used by the Heinz Steven Tool (HST).</span>
<span class="sd">    :type ClutchHST: array</span>

<span class="sd">    :param CorrectionsCells:</span>
<span class="sd">        Array of gear correction strings for debugging. This contains a historic</span>
<span class="sd">        transformation of each gear during all execution and the transformation</span>
<span class="sd">        applied.</span>
<span class="sd">    :type CorrectionsCells: array</span>

<span class="sd">    :param ChecksumVxGear:</span>
<span class="sd">        Checksum of v * gear for v &gt;= 1 km/h rounded to four places of decimal.</span>
<span class="sd">    :type ChecksumVxGear: float</span>

<span class="sd">    :returns:</span>
<span class="sd">        - shift_points (:py:class:`dict`):</span>
<span class="sd">            Dictionary that contains the all input parameters with the expected</span>
<span class="sd">            output format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This is a test parameter that can be included in the inputs in the future</span>
    <span class="n">ReturnAdjustedEngSpeedsAndAvlPowers</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">ReturnAdjustedEngSpeedsAndAvlPowers</span><span class="p">:</span>
        <span class="n">RequiredEngineSpeeds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">PossibleGearsByEngineSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">AvailablePowersFinal</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">PossibleGearsByEngineSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">RequiredEngineSpeedsOutput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">RequiredEngineSpeeds</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">AvailablePowersOutput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">AvailablePowersFinal</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RequiredEngineSpeedsOutput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">InitialRequiredEngineSpeeds</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">AvailablePowersOutput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">InitialAvailablePowers</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">shift_points</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CalculatedGearsOutput&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="p">(</span><span class="n">TraceTimes</span><span class="p">[</span><span class="n">GearSequenceStarts</span><span class="p">],</span> <span class="n">GearNames</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="s2">&quot;AverageGearOutput&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">AverageGear</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s2">&quot;PowerCurveOutput&quot;</span><span class="p">:</span> <span class="n">FullPowerCurve</span><span class="p">,</span>
        <span class="s2">&quot;AdjustedMax95EngineSpeed&quot;</span><span class="p">:</span> <span class="n">Max95EngineSpeedFinal</span><span class="p">,</span>
        <span class="s2">&quot;TraceTimesOutput&quot;</span><span class="p">:</span> <span class="n">TraceTimes</span><span class="p">,</span>
        <span class="s2">&quot;RequiredVehicleSpeedsOutput&quot;</span><span class="p">:</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
        <span class="s2">&quot;RequiredPowersOutput&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">requiredPowersF</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s2">&quot;RequiredEngineSpeedsOutput&quot;</span><span class="p">:</span> <span class="n">RequiredEngineSpeedsOutput</span><span class="p">,</span>
        <span class="s2">&quot;AvailablePowersOutput&quot;</span><span class="p">:</span> <span class="n">AvailablePowersOutput</span><span class="p">,</span>
        <span class="s2">&quot;MaxEngineSpeedCycleOutput&quot;</span><span class="p">:</span> <span class="n">EngineSpeedAtGearAtMaxRequiredSpeed</span><span class="p">,</span>
        <span class="s2">&quot;MaxEngineSpeedReachableOutput&quot;</span><span class="p">:</span> <span class="n">EngineSpeedAtGearAtMaxVehicleSpeed</span><span class="p">,</span>
        <span class="s2">&quot;MaxEngineSpeedOutput&quot;</span><span class="p">:</span> <span class="n">MaxEngineSpeed</span><span class="p">,</span>
        <span class="s2">&quot;MaxVehicleSpeedCycleOutput&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">),</span>
        <span class="s2">&quot;MaxVehicleSpeedReachableOutput&quot;</span><span class="p">:</span> <span class="n">MaxVehicleSpeedFinal</span><span class="p">,</span>
        <span class="s2">&quot;GearMaxVehicleSpeedReachableOutput&quot;</span><span class="p">:</span> <span class="n">GearAtMaxVehicleSpeedFinal</span><span class="p">,</span>
        <span class="s2">&quot;MinDriveEngineSpeed1stOutput&quot;</span><span class="p">:</span> <span class="n">MinDrive1st</span><span class="p">,</span>
        <span class="s2">&quot;MinDriveEngineSpeed1stTo2ndOutput&quot;</span><span class="p">:</span> <span class="n">MinDrive1stTo2nd</span><span class="p">,</span>
        <span class="s2">&quot;MinDriveEngineSpeed2ndDecelOutput&quot;</span><span class="p">:</span> <span class="n">MinDrive2ndDecel</span><span class="p">,</span>
        <span class="s2">&quot;MinDriveEngineSpeed2ndOutput&quot;</span><span class="p">:</span> <span class="n">MinDrive2nd</span><span class="p">,</span>
        <span class="s2">&quot;MinDriveEngineSpeedGreater2ndOutput&quot;</span><span class="p">:</span> <span class="n">MinDriveGreater2nd</span><span class="p">,</span>
        <span class="s2">&quot;GearsOutput&quot;</span><span class="p">:</span> <span class="n">InitialGearsFinalAfterClutch</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;ClutchDisengagedOutput&quot;</span><span class="p">:</span> <span class="n">ClutchDisengagedFinal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;ClutchUndefinedOutput&quot;</span><span class="p">:</span> <span class="n">ClutchUndefinedFinal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;ClutchHSTOutput&quot;</span><span class="p">:</span> <span class="n">ClutchHST</span><span class="p">,</span>
        <span class="s2">&quot;GearCorrectionsOutput&quot;</span><span class="p">:</span> <span class="n">CorrectionsCells</span><span class="p">,</span>
        <span class="s2">&quot;ChecksumVxGearOutput&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ChecksumVxGear</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">shift_points</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2015-2019, European Commission (JRC)

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>